<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Supply Chain Org — IranHotel</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- Export as PNG (html2canvas) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#f4f6fb;
      --paper:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#c7cfe0;

      --shadow:0 18px 44px rgba(15,23,42,.12);
      --shadow2:0 12px 26px rgba(15,23,42,.10);

      --dom:#2563eb; --dom2:#1d4ed8;
      --for:#16a34a; --for2:#15803d;
      --pan:#f59e0b; --pan2:#b45309;
      --cap:#7c3aed; --cap2:#5b21b6;

      --head:#0f172a;
      --r:18px;
      --gap:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Vazirmatn, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .wrap{max-width:1600px;margin:0 auto;padding:18px 16px 44px;}
    .paper{
      background:var(--paper);
      border-radius:24px;
      box-shadow: var(--shadow);
      border:1px solid rgba(15,23,42,.06);
      padding:18px;
      position:relative;
      overflow:hidden;
    }

    /* ===== header ===== */
    .topHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 6px 6px 14px;
      flex-wrap:wrap;
    }
    .brandLeft{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width:0;
      flex: 1 1 520px;
    }
    .logoBox{
      width: 54px;
      height: 54px;
      border-radius: 16px;
      background: #fff;
      border: 1px solid rgba(15,23,42,.10);
      display:grid;
      place-items:center;
      overflow:hidden;
      box-shadow: 0 10px 22px rgba(15,23,42,.08);
      flex:0 0 auto;
    }
    .logoBox img{width:100%;height:100%;object-fit:cover;display:block}
    .brandText{min-width:0}
    .brandText .t1{
      font-weight:900;
      font-size: 14px;
      color:#111827;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandText .t2{
      font-weight:700;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .headerRight{
      display:flex;
      gap: 10px;
      align-items:center;
      flex: 0 0 auto;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      color:#111827;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight:900;
      font-size: 12px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(15,23,42,.06);
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{
      background: #0f172a;
      color: #fff;
      border-color: rgba(255,255,255,.12);
    }

    /* Search */
    .searchBox{
      display:flex;
      gap:10px;
      align-items:center;
      flex: 1 1 360px;
      min-width: 260px;
      justify-content:flex-end;
    }
    .searchBox input{
      width: min(520px, 100%);
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      padding: 11px 12px;
      font-family: inherit;
      font-weight: 800;
      font-size: 12.5px;
      outline:none;
      background:#fff;
      box-shadow: 0 10px 20px rgba(15,23,42,.04);
    }
    .hint{
      font-size: 12px;
      font-weight: 800;
      color: rgba(15,23,42,.62);
      white-space:nowrap;
    }

    /* ===== chart layout ===== */
    #lines{
      position:absolute; inset:0;
      width:100%; height:100%;
      pointer-events:none;
      z-index:1;
    }

    .stack{display:flex;flex-direction:column;gap:12px}
    .center{align-items:center}
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(300px, 1fr));
      gap: 18px;
      position:relative;
      z-index:2;
    }
    .col{
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-width:0;
    }
    .sectionBody{
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-width:0;
    }

    /* domestic special blocks */
    .managerBlock{
      background: rgba(248,250,252,.9);
      border:1px solid rgba(15,23,42,.08);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .subList{
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding-right: 14px;
      position:relative;
    }
    .subList::before{
      content:"";
      position:absolute;
      top: 0; bottom: 0;
      right: 6px;
      width: 2px;
      background: rgba(199,207,224,.9);
      border-radius: 999px;
    }
    .subItem{ position:relative; }
    .subItem::before{
      content:"";
      position:absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 2px;
      background: rgba(199,207,224,.9);
      border-radius: 999px;
    }

    /* ===== cards ===== */
    .card{
      background:#fff;
      border-radius: 18px;
      border:1px solid rgba(15,23,42,.10);
      box-shadow: var(--shadow2);
      padding: 12px 12px;
      display:flex;
      align-items:center;
      gap: 12px;
      min-width:0;
    }
    .card.head{
      background: var(--head);
      color:#fff;
      border:none;
      box-shadow: 0 18px 46px rgba(15,23,42,.24);
      cursor:default;
      max-width: 620px;
      width: min(620px, 100%);
    }
    .card.team{
      box-shadow: none;
      border: 1.5px solid rgba(15,23,42,.18);
      background: #fff;
    }

    .card.person{
      cursor:pointer;
      user-select:none;
      transition:.16s ease;
    }
    .card.person:hover{transform: translateY(-2px)}
    .card.person:active{transform: translateY(0)}
    .card.person.hidden{ display:none !important; }

    /* highlight search hit */
    .card.person.hit{
      outline: 3px solid rgba(37,99,235,.22);
      box-shadow: 0 18px 44px rgba(37,99,235,.16);
    }

    /* team color accents */
    .accent{
      width: 10px;
      height: 46px;
      border-radius: 999px;
      margin-inline-start: auto;
      flex:0 0 auto;
      opacity:.95;
    }
    .accent.dom{background: linear-gradient(180deg, var(--dom), var(--dom2));}
    .accent.for{background: linear-gradient(180deg, var(--for), var(--for2));}
    .accent.pan{background: linear-gradient(180deg, var(--pan), var(--pan2));}
    .accent.cap{background: linear-gradient(180deg, var(--cap), var(--cap2));}
    .card.head .accent{ background: rgba(255,255,255,.22); }

    .avatar{
      width: 46px;
      height: 46px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(37,99,235,.08);
      display:grid;
      place-items:center;
      flex:0 0 auto;
      position:relative;
    }
    .card.head .avatar{
      border-color: rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .initials{
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .6px;
      color: rgba(15,23,42,.78);
    }
    .card.head .initials{ color:#fff; }

    .meta{display:flex;flex-direction:column;gap:4px;min-width:0}
    .name{
      font-weight: 900;
      font-size: 14.6px;
      line-height:1.25;
      white-space: normal;
      word-break: break-word;
    }
    .role{
      font-weight: 700;
      font-size: 12.2px;
      line-height:1.25;
      color: var(--muted);
      white-space: normal;
      word-break: break-word;
    }
    .card.head .role{ color: rgba(255,255,255,.85); }

    .pill{
      font-size: 11px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.04);
      color:#0f172a;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .pill.vacant{
      background: rgba(245,158,11,.14);
      border-style: dashed;
      border-color: rgba(245,158,11,.55);
      color: #7a5b00;
    }
    .pill.dom{ background: rgba(37,99,235,.12); color:#1d4ed8; border-color: rgba(37,99,235,.25); }
    .pill.for{ background: rgba(22,163,74,.12); color:#15803d; border-color: rgba(22,163,74,.25); }
    .pill.pan{ background: rgba(245,158,11,.14); color:#92400e; border-color: rgba(245,158,11,.28); }
    .pill.cap{ background: rgba(124,58,237,.12); color:#5b21b6; border-color: rgba(124,58,237,.25); }

    .scorePill{
      font-size: 11px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.04);
      color:#0f172a;
      white-space:nowrap;
      flex:0 0 auto;
      display:none;
    }
    .scorePill.show{ display:inline-flex; align-items:center; gap:6px; }
    .dot{
      width: 8px; height: 8px; border-radius: 999px;
      background:#94a3b8;
    }
    .dot.good{ background:#16a34a; }
    .dot.mid{ background:#f59e0b; }
    .dot.low{ background:#ef4444; }

    .teamDutiesBtn{
      margin-inline-start:auto;
      border:none;
      background: rgba(15,23,42,.06);
      border:1px solid rgba(15,23,42,.10);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      flex:0 0 auto;
    }
    .teamDutiesBtn:hover{ background: rgba(15,23,42,.09); }

    /* ===== modal ===== */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(2,6,23,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modalBack.open{ display:flex; }

    .modal{
      width: min(980px, 100%);
      background: #fff;
      border-radius: 24px;
      border: 1px solid rgba(15,23,42,.12);
      box-shadow: 0 34px 90px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .modalHead{
      padding: 16px;
      display:flex;
      gap: 14px;
      align-items:center;
      background: linear-gradient(180deg, rgba(248,250,252,.92), #fff);
      border-bottom:1px solid rgba(15,23,42,.08);
    }
    .modalHead .avatar{
      width: 64px; height:64px; border-radius: 18px;
      cursor: zoom-in;
    }
    .modalHead .name{ font-size: 18px; }
    .modalHead .role{ font-size: 13px; }
    .modalHeadRight{
      margin-inline-start:auto;
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .iconBtn{
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
    }
    .iconBtn.primary{
      background:#0f172a;
      color:#fff;
      border-color: rgba(255,255,255,.12);
    }

    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding: 12px 14px;
      border-bottom:1px solid rgba(15,23,42,.08);
      background: rgba(248,250,252,.70);
    }
    .tab{
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      cursor:pointer;
    }
    .tab.active{
      background:#0f172a;
      color:#fff;
      border-color: rgba(15,23,42,.22);
    }

    .tabContent{ display:none; padding: 14px 16px 18px; }
    .tabContent.active{ display:block; }

    .sectionTitle{
      font-weight: 900;
      font-size: 13px;
      color: rgba(15,23,42,.78);
      margin: 0 0 8px;
    }

    .leadText{
      line-height: 2;
      color: rgba(15,23,42,.88);
      font-weight: 700;
      background: rgba(15,23,42,.03);
      border:1px solid rgba(15,23,42,.07);
      border-radius: 16px;
      padding: 12px;
    }

    ul.clean{
      margin: 0;
      padding-right: 18px;
      line-height: 2;
      color: rgba(15,23,42,.88);
      font-weight: 700;
    }

    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .kpiCard{
      border:1px solid rgba(15,23,42,.08);
      border-radius: 18px;
      padding: 12px;
      background: rgba(248,250,252,.9);
    }
    .kpiCard .k{ font-weight: 900; margin-bottom: 6px; }
    .kpiCard .v{ color: rgba(15,23,42,.80); font-weight: 700; line-height:1.8; }

    /* editor */
    .editor{
      border:1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      padding: 12px;
      background: rgba(248,250,252,.85);
      display:none;
      gap: 10px;
    }
    .editor.open{ display:grid; }
    .field{ display:flex; flex-direction:column; gap: 6px; }
    .field label{
      font-weight: 900;
      font-size: 12px;
      color: rgba(15,23,42,.72);
    }
    .field textarea, .field input{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      padding: 10px 10px;
      font-family: inherit;
      font-weight: 700;
      font-size: 13px;
      line-height: 1.8;
      outline:none;
      background:#fff;
    }
    .field textarea{ min-height: 92px; resize: vertical; }
    .editorActions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top: 6px;
    }

    /* drawer */
    .drawerBack{
      position:fixed; inset:0;
      background: rgba(2,6,23,.45);
      display:none;
      z-index:9998;
    }
    .drawerBack.open{ display:block; }
    .drawer{
      position:fixed;
      top: 14px; left: 14px; bottom: 14px;
      width: min(780px, calc(100% - 28px));
      background:#fff;
      border-radius: 22px;
      box-shadow: 0 30px 80px rgba(0,0,0,.35);
      border:1px solid rgba(15,23,42,.12);
      padding: 14px;
      display:none;
      z-index:9999;
      overflow:auto;
    }
    .drawer.open{ display:block; }
    .drawerHead{
      display:flex; gap: 10px;
      align-items:center; justify-content:space-between;
      margin-bottom: 10px;
    }
    .drawerHead .h{ font-weight: 900; font-size: 14px; color:#0f172a; }
    .drawer textarea{
      width:100%;
      min-height: 300px;
      border-radius: 18px;
      border:1px solid rgba(15,23,42,.12);
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      line-height: 1.7;
      outline:none;
    }
    .drawer .mini{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      padding: 10px 10px;
      font-family: inherit;
      font-weight: 800;
      font-size: 12.5px;
      outline:none;
      background:#fff;
    }
    .hr{ height:1px; background: rgba(15,23,42,.10); margin: 10px 0; }

    /* Lightbox (zoom image) */
    .lightboxBack{
      position:fixed; inset:0;
      background: rgba(2,6,23,.82);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 10000;
      padding: 18px;
    }
    .lightboxBack.open{ display:flex; }
    .lightbox{
      width: min(980px, 100%);
      height: min(760px, 100%);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      overflow:hidden;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .lightbox img{
      max-width: 100%;
      max-height: 100%;
      transform-origin: center center;
      cursor: zoom-in;
      user-select:none;
      -webkit-user-drag: none;
    }
    .lbTop{
      position:absolute;
      top: 10px; left: 10px; right: 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      pointer-events:none;
    }
    .lbBadge{
      pointer-events:none;
      background: rgba(0,0,0,.45);
      color:#fff;
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 900;
      font-size: 12px;
      white-space:nowrap;
    }
    .lbBtns{
      display:flex; gap:10px;
      pointer-events:auto;
    }
    .lbBtn{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.45);
      color:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
    }

    @media (max-width: 1200px){
      .grid{ grid-template-columns: repeat(2, minmax(300px, 1fr)); }
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
      #lines{ display:none; }
      .brandText .t2{display:none;}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="paper" id="stage">
    <svg id="lines"></svg>

    <!-- Header -->
    <div class="topHeader">
      <div class="brandLeft">
        <div class="logoBox" title="Logo: images/logo.png">
          <img src="images/logo.jpg" alt="logo"
               onerror="this.style.display='none'; this.parentNode.style.background='#0f172a'; this.parentNode.innerHTML='<span style=&quot;color:#fff;font-weight:900&quot;>LOGO</span>';">
        </div>
        <div class="brandText">
          <div class="t1">IranHotel — Supply Chain Org Chart</div>
          <div class="t2">جستجو، شرح شغل، KPI، امتیاز، و خروجی تصویر</div>
        </div>
      </div>

      <div class="searchBox">
        <span class="hint" id="searchHint">0 نتیجه</span>
        <input id="searchInput" placeholder="جستجو: نام، نقش، تیم (مثال: نرگس | ظرفیت | R&I | Panel)"/>
      </div>

      <div class="headerRight">
        <button class="btn" id="btnExportPng">خروجی تصویر PNG</button>
        <button class="btn" id="btnAdmin">ویرایشگر کلی (JSON + Scores)</button>
        <button class="btn primary" id="btnReset">ریست تغییرات</button>
      </div>
    </div>

    <!-- Top person -->
    <div class="stack center" style="position:relative;z-index:2;margin: 6px 0 16px;">
      <div class="node" id="node-top"></div>
    </div>

    <!-- Departments -->
    <div class="grid" id="grid"></div>
  </div>
</div>

<!-- Modal -->
<div class="modalBack" id="modalBack" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <div class="avatar" id="mAvatar" title="برای بزرگ‌نمایی کلیک کنید">
        <div class="initials" id="mInitials">--</div>
      </div>
      <div class="meta">
        <div class="name" id="mName">—</div>
        <div class="role" id="mRole">—</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
          <span class="pill" id="mTeamPill">—</span>
          <span class="pill" id="mTypePill">—</span>
          <span class="scorePill" id="mScorePill"><span class="dot" id="mScoreDot"></span><span id="mScoreText">Score</span></span>
        </div>
      </div>
      <div class="modalHeadRight">
        <button class="iconBtn" id="btnEdit">ویرایش</button>
        <button class="iconBtn" id="btnRefreshScores">به‌روزرسانی امتیاز</button>
        <button class="iconBtn primary" id="btnClose">بستن ✕</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="tab-overview">Overview</button>
      <button class="tab" data-tab="tab-resp">Responsibilities</button>
      <button class="tab" data-tab="tab-kpi">KPIs</button>
      <button class="tab" data-tab="tab-tools">Tools</button>
      <button class="tab" data-tab="tab-team">Team Duties</button>
      <button class="tab" data-tab="tab-editor">Editor</button>
    </div>

    <div class="tabContent active" id="tab-overview"></div>
    <div class="tabContent" id="tab-resp"></div>
    <div class="tabContent" id="tab-kpi"></div>
    <div class="tabContent" id="tab-tools"></div>
    <div class="tabContent" id="tab-team"></div>

    <div class="tabContent" id="tab-editor">
      <div class="sectionTitle">ویرایشگر شرح شغل همین فرد (ذخیره داخل مرورگر)</div>
      <div class="editor" id="editorBox">
        <div class="field">
          <label>Mission / Overview</label>
          <textarea id="edOverview" placeholder="ماموریت نقش..."></textarea>
        </div>
        <div class="field">
          <label>Responsibilities (هر خط یک مورد)</label>
          <textarea id="edResp" placeholder="مثال: بروزرسانی نرخ&#10;مثال: پیگیری مغایرت"></textarea>
        </div>
        <div class="field">
          <label>KPIs (هر خط یک KPI)</label>
          <textarea id="edKpis" placeholder="Freshness نرخ/ظرفیت&#10;کاهش خطا"></textarea>
        </div>
        <div class="field">
          <label>Tools / Interactions (هر خط)</label>
          <textarea id="edTools" placeholder="Hotel Panel&#10;CRM&#10;Dashboards"></textarea>
        </div>

        <div class="editorActions">
          <button class="btn" id="btnSavePerson">ذخیره</button>
          <button class="btn" id="btnExportPerson">خروجی JSON همین نفر</button>
          <button class="btn primary" id="btnCancelEdit">بستن ویرایش</button>
        </div>
      </div>

      <div style="margin-top:12px;color:var(--muted);font-weight:700;line-height:2">
        نکته: اطلاعات ذخیره‌شده داخل مرورگر (localStorage) می‌ماند. با دکمه «ریست تغییرات» پاک می‌شود.
      </div>
    </div>
  </div>
</div>

<!-- Admin Drawer -->
<div class="drawerBack" id="drawerBack"></div>
<div class="drawer" id="drawer">
  <div class="drawerHead">
    <div class="h">ویرایشگر کلی دیتای شرح شغل + تنظیم امتیاز (Google Sheet)</div>
    <button class="btn primary" id="drawerClose">بستن ✕</button>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
    <button class="btn" id="drawerLoad">بارگذاری از سیستم (JOBS فعلی)</button>
    <button class="btn" id="drawerApply">اعمال JSON روی سیستم</button>
    <button class="btn" id="drawerExport">دانلود JOBS کامل</button>
    <label class="btn" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
      Import JOBS JSON
      <input type="file" id="drawerImport" accept="application/json" style="display:none">
    </label>
  </div>

  <textarea id="drawerText" spellcheck="false"></textarea>

  <div class="hr"></div>

  <div class="sectionTitle">اتصال امتیاز از Google Sheets (CSV)</div>
  <div style="display:grid;gap:10px">
    <input class="mini" id="scoreCsvUrl" placeholder="CSV URL (Publish link) — مثال: https://docs.google.com/spreadsheets/d/e/.../pub?output=csv">
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnSaveScoreConfig">ذخیره تنظیمات امتیاز</button>
      <button class="btn primary" id="btnFetchScores">دریافت امتیازها</button>
    </div>
    <div style="color:var(--muted);font-weight:700;line-height:2">
      ساختار شیت باید حداقل این ستون‌ها را داشته باشد:<br>
      <b>id</b> (مثل: cm1, sp1, cap1, pan2 ...) و <b>score</b> (مثلاً 78) و اختیاری: <b>updated_at</b>.<br>
      برای دسترسی: Google Sheet → File → Share → Publish to web → CSV
    </div>
  </div>

  <div style="margin-top:12px;color:var(--muted);font-weight:700;line-height:2">
    نکته: JOBS و تنظیمات امتیاز داخل مرورگر ذخیره می‌شود.
  </div>
</div>

<!-- Lightbox (Zoom Image) -->
<div class="lightboxBack" id="lbBack" aria-hidden="true">
  <div class="lightbox">
    <div class="lbTop">
      <div class="lbBadge" id="lbTitle">Photo</div>
      <div class="lbBtns">
        <button class="lbBtn" id="lbZoomIn">Zoom +</button>
        <button class="lbBtn" id="lbZoomOut">Zoom −</button>
        <button class="lbBtn" id="lbReset">Reset</button>
        <button class="lbBtn" id="lbClose">Close ✕</button>
      </div>
    </div>
    <img id="lbImg" alt="photo">
  </div>
</div>

<script>
/* =========================
   0) Helpers + Storage Keys
========================= */
const LS_KEY = "IHO_SUPPLY_ORG_JOBS_V2";
const LS_SCORE_CFG = "IHO_SUPPLY_ORG_SCORE_CFG_V1";
const LS_SCORES = "IHO_SUPPLY_ORG_SCORES_V1";

const esc = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({
  "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
}[m]));

const initials = (name) => {
  const parts = String(name||"").trim().split(/\s+/).filter(Boolean);
  const a = parts[0]?.[0] || "?";
  const b = parts[1]?.[0] || (parts[0]?.[1] || "");
  return (a+b);
};

function downloadText(filename, text){
  const blob = new Blob([text], {type:"application/json;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function tryParseJSON(str){
  try { return {ok:true, data: JSON.parse(str)}; }
  catch(e){ return {ok:false, error: e?.message || "Invalid JSON"}; }
}
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

/* =========================
   1) Team Duties
========================= */
const TEAM = {
  top: {
    key:"top", label:"Management", pillClass:"",
    duties:[
      "طراحی و کنترل فرآیندهای Rate & Inventory / Capacity در کل شبکه",
      "تعیین SLA اقدام، استاندارد کیفیت دیتا و کنترل ریسک عملیاتی",
      "هدایت City Managers، تیم ظرفیت و تیم پنل/محتوا",
      "اولویت‌بندی هتل‌های High-impact و مدیریت بحران‌ها",
      "مدیریت backlog توسعه پنل و اتوماسیون‌های تیم",
      "گزارش‌دهی هفتگی/ماهانه و توسعه برنامه بهبود عملکرد"
    ]
  },
  dom: {
    key:"dom", label:"هتل‌های داخلی", pillClass:"dom",
    duties:[
      "مدیریت ارتباط روزانه با هتل‌های داخلی برای نرخ/ظرفیت/پروموشن",
      "بروزرسانی دقیق نرخ‌ها و قوانین فروش + کنترل کیفیت قبل از انتشار",
      "کنترل Capacity و جلوگیری از Over/Under و Missed Sales",
      "رفع مغایرت‌های نرخ/اطلاعات/اتاق‌ها با مستندات هتل",
      "نگهداری لاگ اقدامات و رعایت SLA در تسک‌های حساس",
      "پایش KPIهای منطقه‌ای و Escalation به موقع"
    ]
  },
  for: {
    key:"for", label:"هتل‌های خارجی", pillClass:"for",
    duties:[
      "راه‌اندازی و توسعه تامین هتل‌های خارجی (فرایند، استانداردها، SLA)",
      "مدیریت نرخ/ظرفیت با حساسیت روی Currency، Tax/Fee و Policy",
      "کنترل مپینگ اتاق‌ها و قوانین Cancellation/No-show/Meal plan",
      "هماهنگی بین Account Manager و R&I خارجی برای انتشار دقیق",
      "گزارش و پیگیری نیازهای سیستمی خارجی‌ها با تیم پنل"
    ]
  },
  pan: {
    key:"pan", label:"توسعه پنل و محتوا", pillClass:"pan",
    duties:[
      "تحلیل نیازهای عملیاتی و تبدیل آن‌ها به فیچر/باگ قابل توسعه",
      "افزایش اتوماسیون و کاهش خطای انسانی (Validation / Bulk Update / Logs)",
      "تعریف استاندارد QA و مدیریت Release برای جلوگیری از Regression",
      "بهبود UX پنل برای سرعت اقدام و کاهش اشتباه",
      "مدیریت محتوا: تکمیل داده‌ها، تصاویر، قوانین و استانداردسازی"
    ]
  },
  cap: {
    key:"cap", label:"تیم ظرفیت", pillClass:"cap",
    duties:[
      "پایش روزانه Availability هتل‌های حساس و پرفروش",
      "کنترل Over/Under و هماهنگی سریع برای اصلاح ظرفیت‌ها",
      "ساخت Watchlist ظرفیت و تعریف هشدارهای عملیاتی",
      "گزارش روزانه/هفتگی ظرفیت و موارد بحرانی",
      "کاهش Missed Sales از طریق بهبود Coverage"
    ]
  }
};

/* =========================
   2) Chart Structure
========================= */
const CHART = {
  top: { id:"top", team:"top", type:"Head", name:"محمد باقر ذوالفقاری", role:"Head of Supply Chain", chip:"Management", image:"images/mbz.png" },
  departments: [
    { key:"dom", titleFA:"هتل‌های داخلی", titleEN:"Domestic Hotels", chip:"Domestic", team:"dom",
      blocks:[ {managerId:"cm1", specs:["sp1","sp2"]}, {managerId:"cm2", specs:["sp3","sp4"]}, {managerId:"cm3", specs:["sp5","sp6"]} ]
    },
    { key:"for", titleFA:"هتل‌های خارجی", titleEN:"Foreign Hotels (NEW)", chip:"Foreign", team:"for", stack:["for1","for2","for3"] },
    { key:"pan", titleFA:"توسعه پنل و محتوا", titleEN:"Content & Panel Ops", chip:"Panel", team:"pan", stack:["pan1","pan2","pan3","pan4"] },
    { key:"cap", titleFA:"تیم ظرفیت", titleEN:"Capacity Team", chip:"Capacity", team:"cap", stack:["cap1","cap2"] }
  ],
  people: {
    cm1:{id:"cm1",team:"dom",type:"City Manager",name:"محدثه باقری",role:"City Manager — Center",chip:"Manager",image:"images/m_bagheri.jpg"},
    cm2:{id:"cm2",team:"dom",type:"City Manager",name:"نرگس قدرتی",role:"City Manager — East & South",chip:"Manager",image:"images/n_ghodrati.jpg"},
    cm3:{id:"cm3",team:"dom",type:"City Manager",name:"سپیده داوطلب",role:"City Manager — North & West",chip:"Manager",image:"images/s_davtalab.jpg"},

    sp1:{id:"sp1",team:"dom",type:"R&I Specialist",name:"فاطمه خسروی",role:"Rate & Inventory — Domestic",chip:"R&I",image:"images/f_khosravi.jpg"},
    sp2:{id:"sp2",team:"dom",type:"R&I Specialist",name:"فائزه سالاری",role:"Rate & Inventory — Domestic",chip:"R&I",image:"images/f_salari.jpg"},
    sp3:{id:"sp3",team:"dom",type:"R&I Specialist",name:"فاطمه رنجبر",role:"Rate & Inventory — Domestic",chip:"R&I",image:"images/f_ranjbar.jpg"},
    sp4:{id:"sp4",team:"dom",type:"R&I Specialist",name:"افسانه مرادی",role:"Rate & Inventory — Domestic",chip:"R&I",image:"images/a_moradi.jpg"},
    sp5:{id:"sp5",team:"dom",type:"R&I Specialist",name:"پگاه واعظین",role:"Rate & Inventory — Domestic",chip:"R&I",image:"images/p_vaezin.jpg"},
    sp6:{id:"sp6",team:"dom",type:"R&I Specialist",name:"فاطمه رحیمی",role:"Rate & Inventory — Domestic",chip:"R&I",image:"images/f_rahimi.jpg"},

    for1:{id:"for1",team:"for",type:"Account Manager",name:"Account Manager",role:"Foreign Hotels",chip:"Vacant",vacant:true,image:""},
    for2:{id:"for2",team:"for",type:"R&I Specialist",name:"Rate & Inventory",role:"Foreign Hotels",chip:"Vacant",vacant:true,image:""},
    for3:{id:"for3",team:"for",type:"R&I Specialist",name:"Rate & Inventory",role:"Foreign Hotels",chip:"Vacant",vacant:true,image:""},

    pan1:{id:"pan1",team:"pan",type:"Lead",name:"منصوره یکتایی",role:"Lead — Panel Development",chip:"Lead",image:"images/m_yektaei.jpg"},
    pan2:{id:"pan2",team:"pan",type:"Developer",name:"پریا گلی",role:"Panel Developer",chip:"Team",image:"images/p_goli.jpg"},
    pan3:{id:"pan3",team:"pan",type:"Developer",name:"مهسا ناصری",role:"Panel Developer",chip:"Team",image:"images/m_naseri.jpg"},
    pan4:{id:"pan4",team:"pan",type:"Content Admin",name:"Content Admin",role:"City Project",chip:"Vacant",vacant:true,image:""},

    cap1:{id:"cap1",team:"cap",type:"Capacity Specialist",name:"مهلا بهرامی‌زاده",role:"Capacity Specialist",chip:"Capacity",image:"images/m_bahramizade.jpg"},
    cap2:{id:"cap2",team:"cap",type:"Capacity Specialist",name:"علیرضا بیابانگرد",role:"Capacity Specialist",chip:"Capacity",image:"images/a_biabangard.jpg"},
  }
};

/* =========================
   3) JOBS_DEFAULT (full)
========================= */
const JOBS_DEFAULT = {
  top: {
    overview:"رهبری زنجیره تأمین هتل‌ها برای تضمین درستی و به‌روز بودن نرخ/ظرفیت/محتوا، افزایش فروش و کاهش خطا و ریسک عملیاتی در کانال‌های فروش.",
    responsibilities:[
      "طراحی و کنترل فرآیندهای Rate & Inventory و Capacity در کل شبکه",
      "هدایت City Managers، تیم ظرفیت و تیم پنل/محتوا و تعیین چارچوب‌های همکاری",
      "سیاست‌گذاری SLA اقدام، استانداردهای کیفیت دیتا و کنترل ریسک (Over/Under/Policy)",
      "مدیریت backlog توسعه پنل و اولویت‌بندی اتوماسیون‌ها و حذف کارهای دستی پرتکرار",
      "مدیریت بحران‌ها: مغایرت‌های گسترده، افت فروش، قطع اتصال، شکایات پرتکرار",
      "گزارش‌دهی هفتگی/ماهانه و تعریف برنامه بهبود"
    ],
    kpis:[
      "Freshness نرخ/ظرفیت",
      "نرخ خطا/مغایرت و زمان رفع (TTR)",
      "Availability Coverage و کاهش Missed Sales",
      "تاثیر بر فروش/کانورژن در هتل‌های اولویت‌دار",
      "SLA پاسخ و اقدام تیم"
    ],
    tools:["Hotel Panel / Provider Panels","CRM / Ticketing","Dashboards & Reports","Telegram Ops Channel"]
  },

  cm1:{
    overview:"مالک عملکرد تامین هتل‌های منطقه Center؛ تضمین کیفیت نرخ/ظرفیت، کاهش خطا و پیشبرد فروش منطقه.",
    responsibilities:[
      "تقسیم کار روزانه بین کارشناسان R&I و پیگیری تا بسته شدن تسک‌ها",
      "کنترل کیفیت تغییرات حساس (نرخ‌های کلیدی، محدودیت‌ها، ظرفیت‌های بحرانی)",
      "ارتباط با هتل‌ها برای دریافت نرخ/پروموشن/رفع اختلاف و تثبیت SLA پاسخ",
      "مدیریت مغایرت‌ها و Escalation موارد بحرانی به Head",
      "پایش KPIهای منطقه و ساخت Watchlist هتل‌های high-impact",
      "ثبت گزارش هفتگی: ریسک‌ها، اقدامات و برنامه هفته بعد"
    ],
    kpis:["Freshness منطقه","درصد تسک‌های بسته‌شده در SLA","کاهش مغایرت و خطای تکراری","کاهش missed sales","رشد فروش منطقه"],
    tools:["Hotel Panel","CRM/Tickets","Dashboards","Sheets","Telegram Ops"]
  },
  cm2:{
    overview:"مالک عملکرد تامین هتل‌های East & South؛ کنترل ریسک پیک‌ها، بهبود سرعت اقدام و حفظ کیفیت داده.",
    responsibilities:[
      "مدیریت تیم R&I منطقه و استانداردسازی روال اقدام",
      "پیگیری هتل‌های کم‌پاسخ یا پرخطا و اجرای برنامه اصلاح همکاری",
      "کنترل ظرفیت در پیک‌ها و رویدادها و جلوگیری از under/over",
      "تایید نهایی تغییرات حساس و QA خروجی",
      "تعریف اولویت هتل‌ها و تصمیم‌گیری در بحران‌های روزانه",
      "گزارش‌دهی عملکرد و نیازهای سیستمی به تیم پنل"
    ],
    kpis:["Freshness","کاهش خطا/برگشت کار","Lead time اقدام","Coverage ظرفیت","پایداری فروش در پیک‌ها"],
    tools:["Hotel Panel","CRM/Tickets","Dashboards","Telegram Ops"]
  },
  cm3:{
    overview:"مالک عملکرد تامین هتل‌های North & West؛ پایش نرخ رقابتی، جلوگیری از خطاهای فروش و بهبود conversion منطقه.",
    responsibilities:[
      "هدایت کارشناسان R&I و کنترل کیفی نرخ/قوانین/محدودیت‌ها",
      "پایش نرخ رقابتی و هماهنگی با هتل برای اصلاحات ضروری",
      "کنترل ظرفیت و Stop-sell در بازه‌های حساس",
      "رفع مغایرت‌های پرتکرار و جلوگیری از تکرار خطا",
      "ایجاد Playbook ارتباط با هتل‌ها و قالب‌های استاندارد پیگیری",
      "گزارش‌دهی KPI و Backlog به Head"
    ],
    kpis:["Freshness","خطای تکراری","TTR مغایرت","Coverage ظرفیت","بهبود Conversion"],
    tools:["Hotel Panel","CRM/Tickets","Dashboards","Telegram Ops"]
  },

  sp1:{
    overview:"اجرای دقیق و سریع بروزرسانی نرخ/ظرفیت و نگهداری کیفیت داده برای جلوگیری از خطاهای فروش در هتل‌های داخلی.",
    responsibilities:[
      "ثبت و بروزرسانی نرخ‌ها (Weekday/Weekend/Seasonal/Package)",
      "بروزرسانی ظرفیت/Availability/Stop-sell/Minimum stay طبق تایید CM",
      "اعمال پروموشن‌ها و قوانین فروش با مستندات هتل",
      "بررسی و رفع مغایرت نرخ/ظرفیت/اطلاعات اتاق‌ها",
      "QA سریع: نمونه‌گیری نمایش/رزرو و کنترل قوانین/محدودیت‌ها",
      "ثبت لاگ اقدامات: هتل، تغییر، زمان، نتیجه"
    ],
    kpis:["اقدام موفق بدون خطا","Lead time","نرخ خطا/برگشت کار","SLA","کاهش مغایرت تکراری"],
    tools:["Hotel Panel","Checklists","CRM/Tickets","Telegram Ops","Dashboards"]
  },
  sp2:{
    overview:"اجرای Rate & Inventory برای هتل‌های داخلی با تمرکز بر سرعت اقدام، دقت داده و کاهش خطا.",
    responsibilities:[
      "ثبت/آپدیت نرخ‌ها و محدودیت‌ها طبق سیاست فروش",
      "آپدیت ظرفیت و مدیریت Stop-sell در بازه‌های حساس",
      "پیگیری مغایرت‌ها و همسان‌سازی با مستندات هتل",
      "اعمال پروموشن‌ها و کنترل اثر در نمایش/فروش",
      "ثبت لاگ و گزارش موارد سیستمی به پنل",
      "هماهنگی با City Manager برای اولویت‌بندی روزانه"
    ],
    kpis:["Freshness","SLA","کاهش خطا","کاهش backlog","کیفیت نمایش"],
    tools:["Hotel Panel","CRM/Tickets","Checklists","Dashboards"]
  },
  sp3:{
    overview:"اجرای دقیق تغییرات نرخ/ظرفیت در هتل‌های داخلی و کمک به تثبیت کیفیت داده و کاهش ریسک فروش.",
    responsibilities:[
      "بروزرسانی نرخ‌ها و کنترل صحیح قوانین/شرایط فروش",
      "آپدیت Availability و مدیریت محدودیت‌ها",
      "رفع مغایرت نرخ/ظرفیت/Policy با هماهنگی هتل",
      "کنترل کیفیت اطلاعات اتاق/نام‌گذاری/مپینگ",
      "ثبت دقیق لاگ و مستندسازی موارد حساس",
      "Escalation موارد بحرانی به City Manager"
    ],
    kpis:["نرخ خطا","Freshness","TTR مغایرت","SLA","کیفیت دیتا"],
    tools:["Hotel Panel","CRM/Tickets","Dashboards"]
  },
  sp4:{
    overview:"پایش کیفیت اطلاعات و اجرای عملیات Rate & Inventory با تاکید بر استانداردسازی و کنترل مغایرت‌ها.",
    responsibilities:[
      "ثبت و بروزرسانی نرخ‌ها و ظرفیت‌ها",
      "کنترل کیفیت قوانین (Cancellation/No-show) و محدودیت‌ها",
      "رفع مغایرت‌های اطلاعاتی و جلوگیری از تکرار خطا",
      "اعمال پروموشن‌ها و کنترل اثر آن در فروش/نمایش",
      "ثبت مستندات و لاگ اقدامات",
      "گزارش نیازهای پنل و ابزارها به تیم توسعه"
    ],
    kpis:["کیفیت Policy","کاهش خطای تکراری","Freshness","SLA","دقت داده"],
    tools:["Hotel Panel","CRM/Tickets","Docs/Sheets","Dashboards"]
  },
  sp5:{
    overview:"اجرای بروزرسانی‌های نرخ/ظرفیت و مدیریت استثناها برای حفظ Freshness و کاهش Missed Sales.",
    responsibilities:[
      "آپدیت نرخ و محدودیت‌ها طبق برنامه فروش",
      "کنترل ظرفیت‌های بحرانی و هماهنگی Stop-sell",
      "رفع مغایرت و پایش تکرار خطا",
      "نمونه‌گیری QA برای اطمینان از صحت نمایش",
      "ثبت لاگ و گزارش موارد مهم روزانه",
      "همکاری نزدیک با City Manager برای اولویت‌بندی"
    ],
    kpis:["Freshness","Coverage","SLA","کاهش خطا","کاهش missed sales"],
    tools:["Hotel Panel","Dashboards","Checklists","CRM/Tickets"]
  },
  sp6:{
    overview:"پشتیبانی عملیاتی Rate & Inventory برای هتل‌های داخلی با تمرکز بر دقت، سرعت و کاهش ریسک فروش.",
    responsibilities:[
      "ثبت تغییرات نرخ/ظرفیت و پیگیری موارد معوق",
      "رفع مغایرت‌های پرتکرار با مستندات هتل",
      "کنترل اطلاعات اتاق و قوانین برای جلوگیری از شکایت",
      "ثبت دقیق اقدامات و گزارش موارد بحرانی",
      "هماهنگی با City Manager برای موارد حساس",
      "پیشنهاد بهبود روال‌ها و چک‌لیست‌ها"
    ],
    kpis:["SLA","نرخ خطا","TTR","Freshness","کیفیت دیتا"],
    tools:["Hotel Panel","CRM/Tickets","Checklists","Telegram Ops"]
  },

  for1:{
    overview:"(Vacant) راه‌اندازی و مدیریت ارتباط تجاری/عملیاتی با هتل‌های خارجی؛ دریافت نرخ/قرارداد/قوانین و تضمین فروش‌پذیری.",
    responsibilities:[
      "ایجاد و مدیریت ارتباط با تامین‌کنندگان/هتل‌های خارجی و تثبیت SLA پاسخ",
      "دریافت نرخ‌ها، قراردادها، قوانین و هماهنگی پروموشن‌ها",
      "مدیریت چرخه تایید و انتشار نرخ/ظرفیت با تیم R&I خارجی",
      "کنترل کیفیت داده و حل اختلافات (Price/Tax/Fee/Policy/Availability)",
      "هماهنگی با تیم پنل برای نیازهای خارجی (Currency/Policy/Mapping)",
      "ساخت Playbook خارجی‌ها (Templates, SLA, Standard Policies)"
    ],
    kpis:["تعداد هتل خارجی فعال","Freshness خارجی","TTR مغایرت","رشد فروش خارجی‌ها"],
    tools:["Provider Panels","CRM/Tickets","Dashboards","Email/WhatsApp/Telegram"]
  },
  for2:{
    overview:"(Vacant) اجرای Rate & Inventory برای هتل‌های خارجی با حساسیت بالا روی Policy، Currency و Mapping.",
    responsibilities:[
      "ورود نرخ‌ها با توجه به Currency و Tax/Fee طبق استاندارد",
      "اعمال Availability/Stop-sell و کنترل مپینگ اتاق‌ها",
      "کنترل Policyها (Cancellation/No-show/Meal plan)",
      "هماهنگی با Account Manager برای تغییرات و مستندات",
      "گزارش مشکلات پنل/محدودیت‌های سیستمی"
    ],
    kpis:["Freshness","کیفیت Policy","TTR","SLA","کیفیت Mapping"],
    tools:["Provider Panels","CRM/Tickets","Dashboards"]
  },
  for3:{
    overview:"(Vacant) اجرای Rate & Inventory برای هتل‌های خارجی (پوزیشن دوم) جهت افزایش ظرفیت اجرایی تیم خارجی‌ها.",
    responsibilities:[
      "آپدیت نرخ/ظرفیت و کنترل صحیح نمایش",
      "کنترل قوانین و شرایط فروش برای کاهش اختلاف و شکایت",
      "رفع مغایرت‌های پرتکرار و استانداردسازی داده",
      "کمک در راه‌اندازی فرآیندهای اولیه خارجی‌ها",
      "گزارش‌دهی منظم به Account Manager"
    ],
    kpis:["Freshness","نرخ خطا","SLA","TTR","کیفیت دیتا"],
    tools:["Provider Panels","CRM/Tickets","Dashboards"]
  },

  pan1:{
    overview:"رهبری توسعه پنل و اتوماسیون عملیات تامین برای افزایش سرعت، کاهش خطا و افزایش کنترل‌پذیری تیم Supply.",
    responsibilities:[
      "مدیریت backlog توسعه پنل و اولویت‌بندی بر اساس Impact",
      "تحلیل نیازهای CM/R&I/Capacity و تبدیل به Requirement قابل توسعه",
      "تعریف استاندارد QA و Release Discipline (کاهش Regression)",
      "طراحی ابزارهای کنترل کیفیت (Validation، هشدار، لاگ استاندارد)",
      "هماهنگی برای UAT و پذیرش فیچر",
      "اندازه‌گیری اثر اتوماسیون‌ها و کاهش خطاهای پرتکرار"
    ],
    kpis:["زمان تحویل","Automation impact","کیفیت Release","رضایت عملیات"],
    tools:["Issue Tracker","Repo/CI","Analytics","UAT Checklists","Panel Admin"]
  },
  pan2:{
    overview:"توسعه و بهبود پنل تامین، رفع باگ‌ها و ساخت ابزارهای عملیاتی برای کاهش زمان اقدام تیم.",
    responsibilities:[
      "توسعه فیچرهای نرخ/ظرفیت/پروموشن/لاگ",
      "رفع باگ‌های گزارش‌شده و افزایش پایداری",
      "ساخت Bulk Update و Validation برای کاهش خطای انسانی",
      "بهینه‌سازی UI/UX پنل برای سرعت اقدام",
      "همکاری در تست و انتشار (QA/UAT)",
      "مستندسازی فیچرها"
    ],
    kpis:["Velocity","Bug Return Rate","Stability","Time-to-fix"],
    tools:["Git","Issue Tracker","Panel","Monitoring"]
  },
  pan3:{
    overview:"پشتیبانی توسعه پنل و اجرای درخواست‌های تیم‌های عملیاتی، با تمرکز بر اتوماسیون و کاهش خطا.",
    responsibilities:[
      "رفع باگ‌ها و بهبودهای سریع‌اثر",
      "ساخت ابزارهای کمک‌عملیاتی",
      "بهبود لاگ‌برداری و قابلیت audit",
      "پشتیبانی UAT و استقرار امن",
      "همکاری با Lead برای اولویت‌بندی",
      "مستندسازی تغییرات"
    ],
    kpis:["Time-to-fix","Regression","Impact","Stability"],
    tools:["Git","Issue Tracker","Panel","Monitoring"]
  },
  pan4:{
    overview:"(Vacant) مدیریت محتوا در پروژه‌های شهری: ورود/اصلاح دیتا، استانداردسازی و کنترل کیفیت برای افزایش کانورژن.",
    responsibilities:[
      "ورود/ویرایش مشخصات هتل، اتاق‌ها، امکانات، آدرس/لوکیشن و قوانین",
      "کنترل کیفیت تصاویر و تکمیل گالری‌ها",
      "هماهنگی برای دریافت اطلاعات ناقص",
      "استانداردسازی naming و دسته‌بندی",
      "گزارش کمبودها و اولویت‌بندی تکمیل بر اساس فروش",
      "QA نهایی صفحات هتل‌های اولویت‌دار"
    ],
    kpis:["Content completeness","Conversion impact","SLA تکمیل","Quality errors"],
    tools:["CMS/Panel","Image tools","Checklists","CRM/Tickets"]
  },

  cap1:{
    overview:"کنترل و بهینه‌سازی ظرفیت/Availability برای کاهش missed sales و جلوگیری از overbooking.",
    responsibilities:[
      "پایش روزانه Availability هتل‌های حساس و پر فروش",
      "کنترل Over/Under و اقدام اصلاحی سریع",
      "هماهنگی با CMها و R&I برای اعمال تغییرات",
      "تعریف Watchlist ظرفیت و استاندارد هشدارها",
      "گزارش روزانه/هفتگی ظرفیت و موارد بحرانی"
    ],
    kpis:["Coverage","کاهش missed sales","کاهش over incidents","Speed of response"],
    tools:["Dashboards","Hotel Panel","CRM/Tickets","Alerts/Watchlists"]
  },
  cap2:{
    overview:"پشتیبانی تیم ظرفیت و پیگیری موارد بحرانی و پرتکرار برای بهبود Coverage و Freshness.",
    responsibilities:[
      "کنترل ظرفیت‌های بحرانی و هماهنگی برای اصلاحات",
      "پایش Freshness ظرفیت و کاهش فاصله به‌روزرسانی",
      "کمک در ساخت Watchlist و گزارش‌های عملیاتی",
      "Escalation موارد پرریسک",
      "پیشنهاد بهبود فرآیندهای ظرفیت"
    ],
    kpis:["Freshness capacity","Coverage","TTR بحران","Quality"],
    tools:["Dashboards","Hotel Panel","CRM/Tickets"]
  }
};

/* =========================
   4) Load JOBS overrides
========================= */
function loadJobs(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return structuredClone(JOBS_DEFAULT);
  const parsed = tryParseJSON(raw);
  if(!parsed.ok) return structuredClone(JOBS_DEFAULT);
  const merged = structuredClone(JOBS_DEFAULT);
  for(const k of Object.keys(parsed.data || {})){
    merged[k] = { ...(merged[k]||{}), ...(parsed.data[k]||{}) };
  }
  return merged;
}
let JOBS = loadJobs();

function saveJobsToLS(){
  localStorage.setItem(LS_KEY, JSON.stringify(JOBS, null, 2));
}

/* =========================
   5) Scores (Google Sheet)
========================= */
function loadScoreCfg(){
  const raw = localStorage.getItem(LS_SCORE_CFG);
  if(!raw) return { csvUrl: "" };
  const parsed = tryParseJSON(raw);
  return parsed.ok ? parsed.data : { csvUrl:"" };
}
let SCORE_CFG = loadScoreCfg();

function saveScoreCfg(){
  localStorage.setItem(LS_SCORE_CFG, JSON.stringify(SCORE_CFG, null, 2));
}

function loadScores(){
  const raw = localStorage.getItem(LS_SCORES);
  if(!raw) return {};
  const parsed = tryParseJSON(raw);
  return parsed.ok ? parsed.data : {};
}
let SCORES = loadScores();

function saveScores(){
  localStorage.setItem(LS_SCORES, JSON.stringify(SCORES, null, 2));
}

function parseCSV(text){
  // Simple CSV parser (handles quoted fields)
  const rows = [];
  let i=0, field="", row=[], inQuotes=false;
  while(i<text.length){
    const c=text[i];
    if(inQuotes){
      if(c === '"'){
        if(text[i+1] === '"'){ field+='"'; i+=2; continue; }
        inQuotes=false; i++; continue;
      } else { field+=c; i++; continue; }
    } else {
      if(c === '"'){ inQuotes=true; i++; continue; }
      if(c === ','){ row.push(field); field=""; i++; continue; }
      if(c === '\n' || c === '\r'){
        if(c === '\r' && text[i+1]==='\n') i++;
        row.push(field); field="";
        if(row.length>1 || row[0] !== "") rows.push(row);
        row=[]; i++; continue;
      }
      field+=c; i++; continue;
    }
  }
  row.push(field);
  if(row.length>1 || row[0] !== "") rows.push(row);

  if(rows.length === 0) return [];
  const headers = rows[0].map(h => String(h||"").trim().toLowerCase());
  const data = [];
  for(let r=1;r<rows.length;r++){
    const obj = {};
    for(let c=0;c<headers.length;c++){
      obj[headers[c]] = rows[r][c];
    }
    data.push(obj);
  }
  return data;
}

async function fetchScores(){
  const url = (SCORE_CFG.csvUrl || "").trim();
  if(!url){
    alert("لطفاً CSV URL را در تنظیمات وارد کن.");
    return false;
  }
  try{
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();
    const data = parseCSV(text);

    // Expect: id, score, updated_at(optional)
    const map = {};
    data.forEach(row=>{
      const id = String(row.id || "").trim();
      if(!id) return;
      const scRaw = String(row.score ?? "").trim();
      const sc = Number(scRaw);
      if(Number.isFinite(sc)){
        map[id] = { score: sc, updated_at: String(row.updated_at || "").trim() };
      }
    });

    SCORES = map;
    saveScores();
    applyScoresToUI();
    return true;
  }catch(e){
    alert("خطا در دریافت امتیازها: " + (e?.message || e));
    return false;
  }
}

function scoreDotClass(score){
  if(score >= 80) return "good";
  if(score >= 60) return "mid";
  return "low";
}

/* =========================
   6) Render helpers
========================= */
function avatarHTML(person){
  const img = person.image ? String(person.image) : "";
  const ini = initials(person.name || person.id || "--");
  if(!img){
    return `<div class="avatar"><div class="initials">${esc(ini)}</div></div>`;
  }
  return `
    <div class="avatar">
      <img src="${esc(img)}" alt="${esc(person.name||"")}"
        onerror="this.remove(); this.parentNode.innerHTML='<div class=&quot;initials&quot;>${esc(ini)}</div>';">
    </div>
  `;
}

function chipClass(teamKey){
  const t = TEAM[teamKey]?.pillClass || "";
  return t ? `pill ${t}` : "pill";
}
function accentClass(teamKey){
  const t = TEAM[teamKey]?.pillClass || "";
  return t ? `accent ${t}` : "accent";
}

function scoreHTML(personId){
  const s = SCORES[personId];
  if(!s || typeof s.score !== "number") return `<span class="scorePill" data-score-id="${esc(personId)}"></span>`;
  const cls = scoreDotClass(s.score);
  return `
    <span class="scorePill show" data-score-id="${esc(personId)}" title="${esc(s.updated_at || "")}">
      <span class="dot ${cls}"></span>
      <span>${esc(String(s.score))}</span>
    </span>
  `;
}

function personCard(person){
  const teamPill = TEAM[person.team]?.pillClass || "";
  const pill = person.vacant ? `pill vacant ${teamPill}` : `pill ${teamPill}`;
  const chipText = person.vacant ? "Vacant" : (person.chip || person.type || "");
  const s = scoreHTML(person.id);

  return `
    <div class="card person" data-id="${esc(person.id)}" role="button" tabindex="0"
         data-name="${esc(person.name)}" data-role="${esc(person.role)}" data-team="${esc(TEAM[person.team]?.label || person.team)}">
      ${avatarHTML(person)}
      <div class="meta">
        <div class="name">${esc(person.name)}</div>
        <div class="role">${esc(person.role)}</div>
      </div>
      ${s}
      <span class="${esc(pill)}">${esc(chipText)}</span>
      <div class="${esc(accentClass(person.team))}"></div>
    </div>
  `;
}

function teamHeaderCard(dept){
  return `
    <div class="card team">
      <div class="meta">
        <div class="name">${esc(dept.titleFA)}</div>
        <div class="role">${esc(dept.titleEN)}</div>
      </div>
      <button class="teamDutiesBtn" data-team="${esc(dept.team)}">وظایف تیم</button>
      <span class="pill ${TEAM[dept.team].pillClass}">${esc(dept.chip)}</span>
      <div class="accent ${TEAM[dept.team].pillClass}"></div>
    </div>
  `;
}

function topCard(){
  const p = CHART.top;
  return `
    <div class="card head">
      ${avatarHTML(p)}
      <div class="meta">
        <div class="name">${esc(p.name)}</div>
        <div class="role">${esc(p.role)}</div>
      </div>
      ${scoreHTML("top")}
      <span class="pill">${esc(p.chip)}</span>
      <div class="accent"></div>
    </div>
  `;
}

/* =========================
   7) Render chart
========================= */
function renderChart(){
  document.getElementById("node-top").innerHTML = topCard();

  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  for(const dept of CHART.departments){
    const col = document.createElement("div");
    col.className = "col";
    col.innerHTML += teamHeaderCard(dept);

    const body = document.createElement("div");
    body.className = "sectionBody";

    if(dept.key === "dom"){
      for(const b of dept.blocks){
        const block = document.createElement("div");
        block.className = "managerBlock";

        block.innerHTML += personCard(CHART.people[b.managerId]);

        const sub = document.createElement("div");
        sub.className = "subList";

        for(const sid of b.specs){
          const spec = CHART.people[sid];
          const wrap = document.createElement("div");
          wrap.className = "subItem";
          wrap.innerHTML = personCard(spec);
          sub.appendChild(wrap);
        }
        block.appendChild(sub);
        body.appendChild(block);
      }
    } else {
      for(const id of (dept.stack||[])){
        body.innerHTML += personCard(CHART.people[id]);
      }
    }

    col.appendChild(body);
    grid.appendChild(col);
  }

  wireInteractions();
  applyScoresToUI();
  applySearch(); // keep filter after re-render
}

/* =========================
   8) Minimal lines: top -> team headers
========================= */
function rect(el, stage){
  const r = el.getBoundingClientRect();
  const s = stage.getBoundingClientRect();
  return { cx:(r.left+r.right)/2 - s.left, top:r.top - s.top, bottom:r.bottom - s.top };
}
function addLine(svg,x1,y1,x2,y2){
  const L = document.createElementNS("http://www.w3.org/2000/svg","line");
  L.setAttribute("x1",x1); L.setAttribute("y1",y1);
  L.setAttribute("x2",x2); L.setAttribute("y2",y2);
  L.setAttribute("stroke","var(--line)");
  L.setAttribute("stroke-width","2");
  L.setAttribute("stroke-linecap","round");
  svg.appendChild(L);
}
function redrawLines(){
  const stage = document.getElementById("stage");
  const svg = document.getElementById("lines");
  svg.innerHTML = "";

  const sr = stage.getBoundingClientRect();
  svg.setAttribute("viewBox", `0 0 ${sr.width} ${sr.height}`);

  const top = stage.querySelector("#node-top .card");
  if(!top) return;
  const topR = rect(top, stage);

  const teamCards = [...stage.querySelectorAll(".card.team")];
  if(teamCards.length === 0) return;

  const teamRects = teamCards.map(c => rect(c, stage));
  const y = Math.min(...teamRects.map(t => t.top)) - 16;

  addLine(svg, topR.cx, topR.bottom, topR.cx, y);
  addLine(svg, Math.min(...teamRects.map(t=>t.cx)), y, Math.max(...teamRects.map(t=>t.cx)), y);
  teamRects.forEach(t => addLine(svg, t.cx, y, t.cx, t.top));
}

/* =========================
   9) Modal + Editor
========================= */
const modalBack = document.getElementById("modalBack");
const btnClose = document.getElementById("btnClose");
const btnEdit = document.getElementById("btnEdit");
const btnRefreshScores = document.getElementById("btnRefreshScores");

const mAvatar = document.getElementById("mAvatar");
const mName = document.getElementById("mName");
const mRole = document.getElementById("mRole");
const mTeamPill = document.getElementById("mTeamPill");
const mTypePill = document.getElementById("mTypePill");
const mScorePill = document.getElementById("mScorePill");
const mScoreDot = document.getElementById("mScoreDot");
const mScoreText = document.getElementById("mScoreText");

const tabOverview = document.getElementById("tab-overview");
const tabResp = document.getElementById("tab-resp");
const tabKpi = document.getElementById("tab-kpi");
const tabTools = document.getElementById("tab-tools");
const tabTeam = document.getElementById("tab-team");

const editorBox = document.getElementById("editorBox");
const edOverview = document.getElementById("edOverview");
const edResp = document.getElementById("edResp");
const edKpis = document.getElementById("edKpis");
const edTools = document.getElementById("edTools");

const btnSavePerson = document.getElementById("btnSavePerson");
const btnExportPerson = document.getElementById("btnExportPerson");
const btnCancelEdit = document.getElementById("btnCancelEdit");

let currentPersonId = null;
let currentPerson = null;

function setScoreInModal(id){
  const s = SCORES[id];
  if(!s || typeof s.score !== "number"){
    mScorePill.classList.remove("show");
    return;
  }
  mScorePill.classList.add("show");
  mScoreText.textContent = String(s.score);
  mScoreDot.className = "dot " + scoreDotClass(s.score);
  mScorePill.title = s.updated_at || "";
}

function openModalForPerson(id){
  const person = (id === "top") ? CHART.top : CHART.people[id];
  if(!person) return;

  currentPersonId = id;
  currentPerson = person;

  // avatar
  mAvatar.innerHTML = "";
  const ini = initials(person.name);
  if(person.image){
    const img = document.createElement("img");
    img.src = person.image;
    img.alt = person.name || "";
    img.onerror = () => { mAvatar.innerHTML = `<div class="initials">${esc(ini)}</div>`; };
    mAvatar.appendChild(img);
  } else {
    mAvatar.innerHTML = `<div class="initials">${esc(ini)}</div>`;
  }

  mName.textContent = person.name || "—";
  mRole.textContent = person.role || "—";

  const teamKey = person.team || "top";
  mTeamPill.className = chipClass(teamKey);
  mTeamPill.textContent = TEAM[teamKey]?.label || "—";

  mTypePill.className = "pill";
  mTypePill.textContent = person.type || (person.vacant ? "Vacant" : "—");

  setScoreInModal(id);

  const jd = JOBS[id] || JOBS_DEFAULT[id] || { overview:"شرح شغلی ثبت نشده است.", responsibilities:[], kpis:[], tools:[] };

  tabOverview.innerHTML = `
    <div class="sectionTitle">Mission / Overview</div>
    <div class="leadText">${esc(jd.overview || "—")}</div>
  `;
  tabResp.innerHTML = `
    <div class="sectionTitle">Responsibilities</div>
    <ul class="clean">
      ${(jd.responsibilities||[]).map(x=>`<li>${esc(x)}</li>`).join("") || "<li>—</li>"}
    </ul>
  `;
  tabKpi.innerHTML = `
    <div class="sectionTitle">KPIs</div>
    <div class="kpiGrid">
      ${(jd.kpis||[]).map(k=>`
        <div class="kpiCard"><div class="k">KPI</div><div class="v">${esc(k)}</div></div>
      `).join("") || `<div class="kpiCard"><div class="k">KPI</div><div class="v">—</div></div>`}
    </div>
  `;
  tabTools.innerHTML = `
    <div class="sectionTitle">Tools / Interactions</div>
    <ul class="clean">
      ${(jd.tools||[]).map(x=>`<li>${esc(x)}</li>`).join("") || "<li>—</li>"}
    </ul>
  `;

  const team = TEAM[teamKey] || TEAM.top;
  tabTeam.innerHTML = `
    <div class="sectionTitle">Team Duties — ${esc(team.label)}</div>
    <div class="leadText" style="background:rgba(248,250,252,.9)">
      <ul class="clean" style="margin:0">
        ${(team.duties||[]).map(x=>`<li>${esc(x)}</li>`).join("")}
      </ul>
    </div>
  `;

  // editor
  edOverview.value = jd.overview || "";
  edResp.value = (jd.responsibilities || []).join("\n");
  edKpis.value = (jd.kpis || []).join("\n");
  edTools.value = (jd.tools || []).join("\n");

  modalBack.classList.add("open");
  modalBack.setAttribute("aria-hidden","false");
  setActiveTab("tab-overview");
  closeEditor();
}

function closeModal(){
  modalBack.classList.remove("open");
  modalBack.setAttribute("aria-hidden","true");
  currentPersonId = null;
  currentPerson = null;
  closeEditor();
}

btnClose.addEventListener("click", closeModal);
modalBack.addEventListener("click", (e)=>{ if(e.target === modalBack) closeModal(); });
document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") { closeModal(); closeLightbox(); } });

function setActiveTab(tabId){
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".tabContent").forEach(c => c.classList.remove("active"));
  document.querySelector(`.tab[data-tab="${tabId}"]`)?.classList.add("active");
  document.getElementById(tabId)?.classList.add("active");
}
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=> setActiveTab(t.dataset.tab));
});

function openEditor(){
  editorBox.classList.add("open");
  setActiveTab("tab-editor");
}
function closeEditor(){ editorBox.classList.remove("open"); }

btnEdit.addEventListener("click", ()=>{ if(currentPersonId) openEditor(); });
btnCancelEdit.addEventListener("click", ()=>{ closeEditor(); setActiveTab("tab-overview"); });

btnSavePerson.addEventListener("click", ()=>{
  if(!currentPersonId) return;
  JOBS[currentPersonId] = {
    overview: edOverview.value.trim(),
    responsibilities: edResp.value.split("\n").map(s=>s.trim()).filter(Boolean),
    kpis: edKpis.value.split("\n").map(s=>s.trim()).filter(Boolean),
    tools: edTools.value.split("\n").map(s=>s.trim()).filter(Boolean),
  };
  saveJobsToLS();
  openModalForPerson(currentPersonId);
});

btnExportPerson.addEventListener("click", ()=>{
  if(!currentPersonId) return;
  const out = {};
  out[currentPersonId] = JOBS[currentPersonId] || JOBS_DEFAULT[currentPersonId] || {};
  downloadText(`job_${currentPersonId}.json`, JSON.stringify(out, null, 2));
});

btnRefreshScores.addEventListener("click", async ()=>{
  const ok = await fetchScores();
  if(ok && currentPersonId) setScoreInModal(currentPersonId);
});

/* =========================
   10) Lightbox (zoom image)
========================= */
const lbBack = document.getElementById("lbBack");
const lbImg = document.getElementById("lbImg");
const lbTitle = document.getElementById("lbTitle");
const lbClose = document.getElementById("lbClose");
const lbZoomIn = document.getElementById("lbZoomIn");
const lbZoomOut = document.getElementById("lbZoomOut");
const lbReset = document.getElementById("lbReset");

let lbScale = 1;

function openLightbox(){
  if(!currentPerson || !currentPerson.image) return;
  lbScale = 1;
  lbImg.style.transform = "scale(1)";
  lbImg.src = currentPerson.image;
  lbTitle.textContent = currentPerson.name || "Photo";
  lbBack.classList.add("open");
  lbBack.setAttribute("aria-hidden","false");
}
function closeLightbox(){
  lbBack.classList.remove("open");
  lbBack.setAttribute("aria-hidden","true");
}
function applyLBScale(){
  lbScale = clamp(lbScale, 1, 4);
  lbImg.style.transform = `scale(${lbScale})`;
  lbImg.style.cursor = (lbScale >= 4) ? "zoom-out" : "zoom-in";
}

mAvatar.addEventListener("click", openLightbox);

lbClose.addEventListener("click", closeLightbox);
lbBack.addEventListener("click", (e)=>{ if(e.target === lbBack) closeLightbox(); });
lbZoomIn.addEventListener("click", ()=>{ lbScale += 0.25; applyLBScale(); });
lbZoomOut.addEventListener("click", ()=>{ lbScale -= 0.25; applyLBScale(); });
lbReset.addEventListener("click", ()=>{ lbScale = 1; applyLBScale(); });
lbImg.addEventListener("click", ()=>{
  lbScale = (lbScale >= 2.5) ? 1 : (lbScale + 0.75);
  applyLBScale();
});
lbBack.addEventListener("wheel", (e)=>{
  if(!lbBack.classList.contains("open")) return;
  e.preventDefault();
  lbScale += (e.deltaY > 0 ? -0.1 : 0.1);
  applyLBScale();
}, {passive:false});

/* =========================
   11) Admin Drawer
========================= */
const btnAdmin = document.getElementById("btnAdmin");
const btnReset = document.getElementById("btnReset");
const drawerBack = document.getElementById("drawerBack");
const drawer = document.getElementById("drawer");
const drawerText = document.getElementById("drawerText");
const drawerClose = document.getElementById("drawerClose");
const drawerLoad = document.getElementById("drawerLoad");
const drawerApply = document.getElementById("drawerApply");
const drawerExport = document.getElementById("drawerExport");
const drawerImport = document.getElementById("drawerImport");

const scoreCsvUrl = document.getElementById("scoreCsvUrl");
const btnSaveScoreConfig = document.getElementById("btnSaveScoreConfig");
const btnFetchScores = document.getElementById("btnFetchScores");

function openDrawer(){
  drawerBack.classList.add("open");
  drawer.classList.add("open");
}
function closeDrawer(){
  drawerBack.classList.remove("open");
  drawer.classList.remove("open");
}

btnAdmin.addEventListener("click", ()=>{
  openDrawer();
  drawerText.value = JSON.stringify(JOBS, null, 2);
  scoreCsvUrl.value = SCORE_CFG.csvUrl || "";
});

drawerClose.addEventListener("click", closeDrawer);
drawerBack.addEventListener("click", closeDrawer);

drawerLoad.addEventListener("click", ()=>{ drawerText.value = JSON.stringify(JOBS, null, 2); });

drawerApply.addEventListener("click", ()=>{
  const parsed = tryParseJSON(drawerText.value);
  if(!parsed.ok){ alert("JSON معتبر نیست: " + parsed.error); return; }
  const merged = structuredClone(JOBS_DEFAULT);
  for(const k of Object.keys(parsed.data || {})){
    merged[k] = { ...(merged[k]||{}), ...(parsed.data[k]||{}) };
  }
  JOBS = merged;
  saveJobsToLS();
  alert("اعمال شد ✅");
});

drawerExport.addEventListener("click", ()=> downloadText("jobs_all.json", JSON.stringify(JOBS, null, 2)));

drawerImport.addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const text = await file.text();
  const parsed = tryParseJSON(text);
  if(!parsed.ok){ alert("فایل JSON معتبر نیست: " + parsed.error); return; }
  drawerText.value = JSON.stringify(parsed.data, null, 2);
});

btnReset.addEventListener("click", ()=>{
  if(!confirm("ریست تغییرات؟ تمام ویرایش‌های ذخیره‌شده + تنظیمات امتیاز پاک می‌شود.")) return;
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_SCORE_CFG);
  localStorage.removeItem(LS_SCORES);
  JOBS = structuredClone(JOBS_DEFAULT);
  SCORE_CFG = { csvUrl:"" };
  SCORES = {};
  alert("ریست شد ✅");
  renderChart();
});

btnSaveScoreConfig.addEventListener("click", ()=>{
  SCORE_CFG.csvUrl = (scoreCsvUrl.value || "").trim();
  saveScoreCfg();
  alert("تنظیمات امتیاز ذخیره شد ✅");
});

btnFetchScores.addEventListener("click", async ()=>{
  SCORE_CFG.csvUrl = (scoreCsvUrl.value || "").trim();
  saveScoreCfg();
  await fetchScores();
});

/* =========================
   12) Wire interactions + team duties
========================= */
function wireInteractions(){
  document.querySelectorAll(".card.person").forEach(card=>{
    card.addEventListener("click", ()=> openModalForPerson(card.dataset.id));
    card.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        openModalForPerson(card.dataset.id);
      }
    });
  });

  document.querySelectorAll(".teamDutiesBtn").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.stopPropagation();
      const teamKey = btn.dataset.team;
      let id = "top";
      if(teamKey !== "top"){
        const found = Object.values(CHART.people).find(p => p.team === teamKey);
        id = found?.id || "top";
      }
      openModalForPerson(id);
      setActiveTab("tab-team");
    });
  });
}

/* =========================
   13) Apply scores to cards + modal
========================= */
function applyScoresToUI(){
  document.querySelectorAll(".scorePill").forEach(el=>{
    const id = el.getAttribute("data-score-id");
    const s = SCORES[id];
    if(!s || typeof s.score !== "number"){
      el.classList.remove("show");
      el.innerHTML = "";
      return;
    }
    el.classList.add("show");
    const cls = scoreDotClass(s.score);
    el.innerHTML = `<span class="dot ${cls}"></span><span>${esc(String(s.score))}</span>`;
    el.title = s.updated_at || "";
  });
}

/* =========================
   14) Search
========================= */
const searchInput = document.getElementById("searchInput");
const searchHint = document.getElementById("searchHint");

let searchTerm = "";

function norm(s){
  return String(s||"")
    .toLowerCase()
    .replace(/\s+/g," ")
    .trim();
}

function applySearch(){
  const q = norm(searchTerm);
  const cards = [...document.querySelectorAll(".card.person")];

  if(!q){
    cards.forEach(c=>{ c.classList.remove("hidden","hit"); });
    searchHint.textContent = `${cards.length} نفر`;
    return;
  }

  let hits = 0;
  cards.forEach(c=>{
    const hay = norm((c.dataset.name||"") + " " + (c.dataset.role||"") + " " + (c.dataset.team||""));
    const ok = hay.includes(q);
    c.classList.toggle("hidden", !ok);
    c.classList.toggle("hit", ok);
    if(ok) hits++;
  });
  searchHint.textContent = `${hits} نتیجه`;
}

searchInput.addEventListener("input", ()=>{
  searchTerm = searchInput.value;
  applySearch();
  // redraw lines might be off; keep minimal
});

/* =========================
   15) Export PNG
========================= */
const btnExportPng = document.getElementById("btnExportPng");
btnExportPng.addEventListener("click", async ()=>{
  const stage = document.getElementById("stage");
  // temporarily remove highlights for nicer export? keep as-is.
  try{
    // Improve image clarity
    const canvas = await html2canvas(stage, {
      backgroundColor: "#ffffff",
      scale: 2,
      useCORS: true
    });
    const url = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = url;
    a.download = "supply_org_chart.png";
    document.body.appendChild(a);
    a.click();
    a.remove();
  }catch(e){
    alert("خروجی تصویر ناموفق بود. اگر با file:// باز کردی، لطفاً با Live Server اجرا کن. خطا: " + (e?.message||e));
  }
});

/* =========================
   16) Fetch scores on load (optional)
========================= */
async function autoLoadScores(){
  // If we have cached scores, show them immediately.
  applyScoresToUI();
  // If csvUrl exists, you can uncomment next line to auto-refresh on each open:
  // if((SCORE_CFG.csvUrl||"").trim()) await fetchScores();
}

/* =========================
   17) Init
========================= */
renderChart();
autoLoadScores();

window.addEventListener("load", redrawLines);
window.addEventListener("resize", redrawLines);
document.addEventListener("load", (e)=>{ if(e.target?.tagName==="IMG") setTimeout(redrawLines, 10); }, true);
</script>
</body>
</html>
