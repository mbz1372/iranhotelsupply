<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>IranHotel | Supply Chain Org Chart</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;800;900&display=swap" rel="stylesheet">

  <!-- Export PNG -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0a1a2f;
      --paper:#ffffff;
      --card:#f6f8fc;
      --card2:#eef2f8;
      --text:#0f172a;
      --muted:#64748b;
      --border: rgba(15,23,42,.10);
      --shadow: 0 20px 60px rgba(2,6,23,.18);
      --shadow2: 0 12px 26px rgba(2,6,23,.10);
      --radius: 20px;
      --radius2: 16px;
      --line1:#cbd5e1;
      --line2:#94a3b8;
      --primary:#0f172a;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Vazirmatn, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 70% -10%, rgba(56,189,248,.18), transparent 60%),
        radial-gradient(900px 520px at 10% 0%, rgba(34,197,94,.12), transparent 55%),
        linear-gradient(180deg, #f2f5fb 0%, #eef2f7 45%, #e9eef6 100%);
    }

    /* ====== Header ====== */
    .siteHeader{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      background: rgba(255,255,255,.72);
      border-bottom: 1px solid rgba(15,23,42,.06);
    }
    .headerInner{
      max-width: 1600px;
      margin: 0 auto;
      padding: 12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brandMini{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .brandMini .logo{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 18px rgba(2,6,23,.10);
      background: #fff;
      flex:0 0 auto;
      display:grid;
      place-items:center;
    }
    .brandMini .logo img{width:100%;height:100%;object-fit:cover;display:block}
    .brandMini .txt{
      display:flex;flex-direction:column;gap:2px;
      min-width:0;
    }
    .brandMini .txt .t1{font-weight:900;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brandMini .txt .t2{font-weight:800;font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .nav{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .nav a{
      text-decoration:none;
      color: rgba(15,23,42,.85);
      font-weight: 900;
      font-size: 12px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.65);
      transition: .15s ease;
    }
    .nav a:hover{transform: translateY(-1px); background:#fff}

    .headerActions{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      color:#111827;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight:900;
      font-size: 12px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(15,23,42,.06);
    }
    .btn.primary{
      background: #0f172a;
      color: #fff;
      border-color: rgba(255,255,255,.12);
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0)}

    /* Search icon input */
    .searchWrap{
      position:relative;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .searchBtn{
      width: 40px;height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.10);
      background: #fff;
      cursor:pointer;
      display:grid;place-items:center;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
    }
    .searchBtn svg{width:18px;height:18px;opacity:.8}
    .searchInput{
      width: 0;
      opacity:0;
      pointer-events:none;
      transition: .18s ease;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.10);
      padding: 11px 12px;
      font-family: inherit;
      font-weight: 900;
      font-size: 12px;
      outline:none;
      background:#fff;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
    }
    .searchWrap.open .searchInput{
      width: min(420px, 46vw);
      opacity:1;
      pointer-events:auto;
    }

    /* ====== Layout ====== */
    .wrap{
      max-width: 1600px;
      margin: 0 auto;
      padding: 16px 16px 44px;
    }

    /* Hero center */
    .hero{
      margin-top: 14px;
      background: linear-gradient(135deg, rgba(15,23,42,.92), rgba(2,6,23,.94));
      color:#fff;
      border-radius: 26px;
      padding: 22px 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .hero::before{
      content:"";
      position:absolute;inset:-40px;
      background:
        radial-gradient(400px 220px at 20% 20%, rgba(56,189,248,.28), transparent 60%),
        radial-gradient(420px 240px at 80% 30%, rgba(34,197,94,.20), transparent 60%),
        radial-gradient(520px 300px at 55% 120%, rgba(245,158,11,.18), transparent 60%);
      filter: blur(0px);
      opacity:.95;
    }
    .heroInner{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 12px;
      flex-wrap:wrap;
      text-align:center;
    }
    .heroLogo{
      width: 64px;height:64px;
      border-radius: 20px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      box-shadow: 0 18px 40px rgba(0,0,0,.30);
      flex:0 0 auto;
    }
    .heroLogo img{width:100%;height:100%;object-fit:cover;display:block}
    .heroTitle{
      display:flex;flex-direction:column;gap:6px;
      align-items:center;
      justify-content:center;
    }
    .heroTitle h1{
      margin:0;
      font-size: 18px;
      font-weight: 950;
      letter-spacing: .2px;
    }
    .heroTitle p{
      margin:0;
      font-size: 12px;
      font-weight: 800;
      color: rgba(255,255,255,.82);
      line-height: 1.9;
    }

    /* stage */
    .paper{
      margin-top: 16px;
      background: var(--paper);
      border-radius: 26px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(15,23,42,.06);
      padding: 18px;
      position: relative;
      overflow: hidden;
    }

    #lines{
      position:absolute; inset:0;
      width:100%; height:100%;
      pointer-events:none;
      z-index:1;
    }

    /* Top node */
    .topRow{
      display:flex;
      justify-content:center;
      position:relative;
      z-index:2;
      padding: 10px 0 18px;
    }

    /* Columns */
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(300px, 1fr));
      gap: 18px;
      position:relative;
      z-index:2;
      align-items:start;
    }
    .col{display:flex;flex-direction:column;gap: 12px;min-width:0}
    .sectionBody{display:flex;flex-direction:column;gap:12px}

    /* Team header */
    .teamHeader{
      background: linear-gradient(180deg, #fff, #fbfcff);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 12px 26px rgba(2,6,23,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      min-width:0;
    }
    .teamHeader .t{
      display:flex;flex-direction:column;gap:3px;
      min-width:0;
    }
    .teamHeader .t .a{font-weight:950;font-size:14px}
    .teamHeader .t .b{font-weight:800;font-size:11px;color:var(--muted)}
    .teamHeader .btnTiny{
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.04);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 950;
      font-size: 12px;
      cursor:pointer;
      white-space:nowrap;
    }
    .teamHeader .btnTiny:hover{background: rgba(15,23,42,.07)}

    /* Domestic manager blocks */
    .managerBlock{
      background: linear-gradient(180deg, var(--card), #fff);
      border:1px solid rgba(15,23,42,.08);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .subList{
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding-right: 14px;
      position:relative;
    }
    .subList::before{
      content:"";
      position:absolute;
      top: 0; bottom: 0;
      right: 6px;
      width: 2px;
      background: rgba(203,213,225,.95);
      border-radius: 999px;
    }
    .subItem{ position:relative; }
    .subItem::before{
      content:"";
      position:absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 2px;
      background: rgba(203,213,225,.95);
      border-radius: 999px;
    }

    /* Person cards */
    .card{
      background: var(--card);
      border-radius: 18px;
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: var(--shadow2);
      padding: 12px;
      display:flex;
      align-items:center;
      gap: 12px;
      min-width:0;
    }
    .card.head{
      background: linear-gradient(180deg, #0f172a, #111b2f);
      color:#fff;
      border:none;
      box-shadow: 0 22px 60px rgba(2,6,23,.28);
      max-width: 760px;
      width: min(760px, 100%);
      cursor: default;
    }
    .card.person{
      cursor:pointer;
      user-select:none;
      transition:.16s ease;
    }
    .card.person:hover{transform: translateY(-2px)}
    .card.person:active{transform: translateY(0)}
    .card.person.hidden{display:none !important;}
    .card.person.hit{
      outline: 3px solid rgba(59,130,246,.18);
      box-shadow: 0 22px 60px rgba(59,130,246,.14);
    }

    .avatar{
      width: 46px;
      height: 46px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(59,130,246,.10);
      display:grid;
      place-items:center;
      flex:0 0 auto;
      position:relative;
    }
    .card.head .avatar{
      border-color: rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block;}
    .initials{font-weight:950;font-size:12px;letter-spacing:.6px;color:rgba(15,23,42,.75)}
    .card.head .initials{color:#fff}

    .meta{display:flex;flex-direction:column;gap:4px;min-width:0}
    .name{
      font-weight: 950;
      font-size: 14.5px;
      line-height: 1.25;
      word-break: break-word;
    }
    .role{
      font-weight: 850;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.25;
      word-break: break-word;
    }
    .card.head .role{color: rgba(255,255,255,.85)}

    .pill{
      margin-inline-start:auto;
      font-size: 11px;
      font-weight: 950;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.05);
      color:#0f172a;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .pill.vacant{
      background: rgba(245,158,11,.14);
      border-style:dashed;
      border-color: rgba(245,158,11,.55);
      color: #7a5b00;
    }
    .scorePill{
      font-size: 11px;
      font-weight: 950;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.05);
      display:none;
      align-items:center;
      gap:6px;
      flex:0 0 auto;
    }
    .scorePill.show{display:inline-flex}
    .dot{width:8px;height:8px;border-radius:999px;background:#94a3b8}
    .dot.good{background:#16a34a}
    .dot.mid{background:#f59e0b}
    .dot.low{background:#ef4444}

    /* Sections (About/Contact) */
    section{
      max-width: 1600px;
      margin: 18px auto 0;
      padding: 0 16px;
    }
    .sectionCard{
      background: rgba(255,255,255,.80);
      border: 1px solid rgba(15,23,42,.08);
      border-radius: 26px;
      box-shadow: 0 18px 50px rgba(2,6,23,.12);
      padding: 18px;
      overflow:hidden;
    }
    .sectionCard h2{
      margin: 0 0 8px;
      font-size: 16px;
      font-weight: 950;
    }
    .sectionCard p, .sectionCard li{
      margin: 0;
      color: rgba(15,23,42,.82);
      font-weight: 800;
      line-height: 2;
      font-size: 13px;
    }
    .sectionGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 16px;
      margin-top: 14px;
    }
    .box{
      background: rgba(248,250,252,.9);
      border: 1px solid rgba(15,23,42,.08);
      border-radius: 18px;
      padding: 14px;
    }
    .box h3{margin:0 0 8px;font-size:13px;font-weight:950}
    .box ul{margin:0;padding-right:18px}

    /* Footer */
    footer{
      margin-top: 18px;
      padding: 22px 16px;
      background: rgba(15,23,42,.96);
      color: rgba(255,255,255,.88);
    }
    .footerInner{
      max-width: 1600px;
      margin:0 auto;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 16px;
      flex-wrap:wrap;
    }
    .footerCol{min-width:220px}
    .footerCol .ft{font-weight:950;margin-bottom:8px}
    .footerCol .fs{font-weight:800;font-size:12px;line-height:2;color:rgba(255,255,255,.78)}
    .footerLinks{
      display:flex;flex-wrap:wrap;gap:10px;margin-top:10px
    }
    .footerLinks a{
      color:#fff;text-decoration:none;font-weight:900;font-size:12px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }

    @media (max-width: 1200px){
      .grid{grid-template-columns: repeat(2, minmax(300px, 1fr));}
      .sectionGrid{grid-template-columns: 1fr;}
    }
    @media (max-width: 720px){
      .grid{grid-template-columns: 1fr;}
      #lines{display:none;}
      .nav{display:none;}
      .searchWrap.open .searchInput{width: min(420px, 76vw);}
    }
  </style>
</head>

<body>

<header class="siteHeader">
  <div class="headerInner">
    <div class="brandMini">
      <div class="logo" title="images/logo.png">
        <img src="./images/logo.png" alt="logo" crossorigin="anonymous"
             onerror="this.style.display='none'; this.parentNode.innerHTML='<span style=&quot;color:#0f172a;font-weight:950&quot;>IH</span>';">
      </div>
      <div class="txt">
        <div class="t1">IranHotel • Supply Chain</div>
        <div class="t2">Org Chart • Search • Export</div>
      </div>
    </div>

    <nav class="nav">
      <a href="#chart">چارت</a>
      <a href="#about">درباره ما</a>
      <a href="#contact">ارتباط با ما</a>
    </nav>

    <div class="headerActions">
      <div class="searchWrap" id="searchWrap">
        <button class="searchBtn" id="searchBtn" title="جستجو">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/>
            <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <input class="searchInput" id="searchInput" placeholder="جستجو: نام، نقش، تیم… (مثال: شجاع | ظرفیت | پنل)">
      </div>

      <button class="btn" id="btnScores">به‌روزرسانی امتیازها</button>
      <button class="btn primary" id="btnExportPng">خروجی PNG</button>
    </div>
  </div>
</header>

<div class="wrap" id="chart">
  <div class="hero">
    <div class="heroInner">
      <div class="heroLogo">
        <img src="./images/logo.png" alt="logo" crossorigin="anonymous"
             onerror="this.style.display='none'; this.parentNode.style.display='grid'; this.parentNode.style.placeItems='center'; this.parentNode.innerHTML='<span style=&quot;color:#fff;font-weight:950&quot;>IH</span>';">
      </div>
      <div class="heroTitle">
        <h1>چارت سازمانی تیم زنجیره تأمین</h1>
        <p>IranHotel Online • Supply Chain Organization • کلیک روی هر کارت برای مشاهده شرح وظایف</p>
      </div>
    </div>
  </div>

  <div class="paper" id="stage">
    <svg id="lines" aria-hidden="true"></svg>

    <div class="topRow">
      <div id="node-top"></div>
    </div>

    <div class="grid" id="grid"></div>
  </div>
</div>

<section id="about">
  <div class="sectionCard">
    <h2>درباره ما</h2>
    <p>
      این صفحه برای نمایش ساختار تیم زنجیره‌تأمین (Supply Chain) در IranHotel طراحی شده تا مدیریت،
      هماهنگی بین تیم‌ها، و شفافیت نقش‌ها و وظایف به شکل یکپارچه و قابل ارائه فراهم شود.
    </p>

    <div class="sectionGrid">
      <div class="box">
        <h3>هدف</h3>
        <ul>
          <li>شفاف‌سازی ساختار تیم‌ها و زیرمجموعه‌ها</li>
          <li>دسترسی سریع به شرح وظایف هر نقش</li>
          <li>امکان جستجوی نام/نقش و خروجی تصویر برای ارائه مدیریتی</li>
        </ul>
      </div>
      <div class="box">
        <h3>راهنما</h3>
        <ul>
          <li>روی هر کارت کلیک کن تا جزئیات باز شود</li>
          <li>از آیکن سرچ برای فیلتر سریع استفاده کن</li>
          <li>برای ارائه، خروجی PNG بگیر</li>
        </ul>
      </div>
    </div>
  </div>
</section>

<section id="contact">
  <div class="sectionCard">
    <h2>ارتباط با ما</h2>
    <p>برای پیشنهاد بهبود، اصلاح ساختار، یا درخواست فیچرهای جدید (مثلاً KPI Dashboard) می‌تونی از این بخش استفاده کنی.</p>

    <div class="sectionGrid">
      <div class="box">
        <h3>اطلاعات تماس</h3>
        <ul>
          <li>شرکت: IranHotelOnline</li>
          <li>واحد: Supply Chain</li>
          <li>ایمیل/تلفن: (اینجا بعداً وارد کن)</li>
        </ul>
      </div>
      <div class="box">
        <h3>درخواست‌های رایج</h3>
        <ul>
          <li>اضافه/حذف نفرات و اصلاح زیرمجموعه‌ها</li>
          <li>اتصال امتیازها به Google Sheet</li>
          <li>نسخه پرینتی A4 یا نسخه ارائه مدیریتی</li>
        </ul>
      </div>
    </div>
  </div>
</section>

<footer>
  <div class="footerInner">
    <div class="footerCol">
      <div class="ft">IranHotel • Supply Chain</div>
      <div class="fs">نسخه تعاملی چارت سازمانی — مناسب Jira / Confluence / Management Review</div>
      <div class="footerLinks">
        <a href="#chart">چارت</a>
        <a href="#about">درباره ما</a>
        <a href="#contact">ارتباط با ما</a>
      </div>
    </div>
    <div class="footerCol">
      <div class="ft">نکته</div>
      <div class="fs">عکس‌ها باید داخل فولدر <b>images</b> و با نام دقیق فایل‌ها روی Vercel قرار بگیرند.</div>
    </div>
    <div class="footerCol">
      <div class="ft">©</div>
      <div class="fs">All rights reserved — IranHotelOnline</div>
    </div>
  </div>
</footer>

<!-- Modal -->
<div class="modalBack" id="modalBack" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,.62);z-index:9999;align-items:center;justify-content:center;padding:18px;">
  <div class="modal" style="width:min(980px,100%);background:#fff;border-radius:24px;border:1px solid rgba(15,23,42,.12);box-shadow:0 34px 90px rgba(0,0,0,.35);overflow:hidden;">
    <div class="modalHead" style="padding:16px;display:flex;gap:14px;align-items:center;background:linear-gradient(180deg, rgba(248,250,252,.92), #fff);border-bottom:1px solid rgba(15,23,42,.08);">
      <div class="avatar" id="mAvatar" title="برای بزرگ‌نمایی کلیک کنید" style="width:64px;height:64px;border-radius:18px;cursor:zoom-in;"></div>
      <div class="meta" style="min-width:0">
        <div class="name" id="mName" style="font-size:18px;font-weight:950"></div>
        <div class="role" id="mRole" style="font-size:13px;font-weight:850;color:var(--muted)"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <span class="pill" id="mTeamPill"></span>
          <span class="pill" id="mTypePill"></span>
          <span class="scorePill" id="mScorePill"><span class="dot" id="mScoreDot"></span><span id="mScoreText">Score</span></span>
        </div>
      </div>
      <div style="margin-inline-start:auto;display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn" id="btnRefreshScores">به‌روزرسانی امتیاز</button>
        <button class="btn primary" id="btnClose">بستن ✕</button>
      </div>
    </div>

    <div class="tabs" style="display:flex;flex-wrap:wrap;gap:8px;padding:12px 14px;border-bottom:1px solid rgba(15,23,42,.08);background:rgba(248,250,252,.70);">
      <button class="tab active" data-tab="tab-overview" style="padding:8px 12px;border-radius:999px;font-weight:950;font-size:12px;border:1px solid rgba(15,23,42,.10);background:#0f172a;color:#fff;cursor:pointer;">Overview</button>
      <button class="tab" data-tab="tab-resp" style="padding:8px 12px;border-radius:999px;font-weight:950;font-size:12px;border:1px solid rgba(15,23,42,.10);background:#fff;cursor:pointer;">Responsibilities</button>
      <button class="tab" data-tab="tab-kpi" style="padding:8px 12px;border-radius:999px;font-weight:950;font-size:12px;border:1px solid rgba(15,23,42,.10);background:#fff;cursor:pointer;">KPIs</button>
      <button class="tab" data-tab="tab-tools" style="padding:8px 12px;border-radius:999px;font-weight:950;font-size:12px;border:1px solid rgba(15,23,42,.10);background:#fff;cursor:pointer;">Tools</button>
      <button class="tab" data-tab="tab-team" style="padding:8px 12px;border-radius:999px;font-weight:950;font-size:12px;border:1px solid rgba(15,23,42,.10);background:#fff;cursor:pointer;">Team Duties</button>
    </div>

    <div class="tabContent active" id="tab-overview" style="padding:14px 16px 18px"></div>
    <div class="tabContent" id="tab-resp" style="display:none;padding:14px 16px 18px"></div>
    <div class="tabContent" id="tab-kpi" style="display:none;padding:14px 16px 18px"></div>
    <div class="tabContent" id="tab-tools" style="display:none;padding:14px 16px 18px"></div>
    <div class="tabContent" id="tab-team" style="display:none;padding:14px 16px 18px"></div>
  </div>
</div>

<!-- Lightbox -->
<div id="lbBack" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,.82);z-index:10000;padding:18px;align-items:center;justify-content:center;">
  <div style="width:min(980px,100%);height:min(760px,100%);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);border-radius:22px;overflow:hidden;position:relative;display:flex;align-items:center;justify-content:center;">
    <div style="position:absolute;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <div id="lbTitle" style="background:rgba(0,0,0,.45);color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:8px 10px;font-weight:950;font-size:12px;">Photo</div>
      <div style="display:flex;gap:10px;">
        <button class="btn" id="lbZoomIn">Zoom +</button>
        <button class="btn" id="lbZoomOut">Zoom −</button>
        <button class="btn" id="lbReset">Reset</button>
        <button class="btn primary" id="lbClose">Close ✕</button>
      </div>
    </div>
    <img id="lbImg" alt="photo" crossorigin="anonymous" style="max-width:100%;max-height:100%;transform-origin:center;user-select:none;-webkit-user-drag:none;cursor:zoom-in">
  </div>
</div>

<script>
/* ========= Helpers ========= */
const esc = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({
  "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
}[m]));
const initials = (name) => {
  const parts = String(name||"").trim().split(/\s+/).filter(Boolean);
  const a = parts[0]?.[0] || "؟";
  const b = parts[1]?.[0] || (parts[0]?.[1] || "");
  return (a+b);
};
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function norm(s){ return String(s||"").toLowerCase().replace(/\s+/g," ").trim(); }

/* ========= Scores ========= */
const SCORE_SHEET_URL = ""; // اگر خواستی، اینجا gviz/csv را بذار
let SCORES = {}; // {id:{score:number, updated_at:string}}

function scoreDotClass(score){
  if(score >= 80) return "good";
  if(score >= 60) return "mid";
  return "low";
}
function parseCSV(text){
  const rows = [];
  let i=0, field="", row=[], inQuotes=false;
  while(i<text.length){
    const c=text[i];
    if(inQuotes){
      if(c === '"'){
        if(text[i+1] === '"'){ field+='"'; i+=2; continue; }
        inQuotes=false; i++; continue;
      } else { field+=c; i++; continue; }
    } else {
      if(c === '"'){ inQuotes=true; i++; continue; }
      if(c === ','){ row.push(field); field=""; i++; continue; }
      if(c === '\n' || c === '\r'){
        if(c === '\r' && text[i+1]==='\n') i++;
        row.push(field); field="";
        if(row.length>1 || row[0] !== "") rows.push(row);
        row=[]; i++; continue;
      }
      field+=c; i++; continue;
    }
  }
  row.push(field);
  if(row.length>1 || row[0] !== "") rows.push(row);
  if(rows.length === 0) return [];
  const headers = rows[0].map(h => String(h||"").trim().toLowerCase());
  const data = [];
  for(let r=1;r<rows.length;r++){
    const obj = {};
    for(let c=0;c<headers.length;c++){
      obj[headers[c]] = rows[r][c];
    }
    data.push(obj);
  }
  return data;
}
function normalizeGoogleSheetUrl(inputUrl){
  const url = (inputUrl || "").trim();
  if(!url) return "";
  const m = url.match(/https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  if(m){
    const id = m[1];
    const gidMatch = url.match(/[?&#]gid=(\d+)/);
    const gid = gidMatch ? gidMatch[1] : "";
    if(gid){
      return `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&gid=${gid}`;
    }
    return `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv`;
  }
  return url;
}
async function fetchScores(){
  const rawUrl = (SCORE_SHEET_URL || "").trim();
  if(!rawUrl){
    alert("لینک امتیازها تنظیم نشده. داخل کد مقدار SCORE_SHEET_URL را وارد کن (CSV / gviz).");
    return false;
  }
  const url = normalizeGoogleSheetUrl(rawUrl);
  try{
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();
    const data = parseCSV(text);

    const map = {};
    data.forEach(row=>{
      const id = String(row.id || "").trim();
      if(!id) return;
      const sc = Number(String(row.score ?? "").trim());
      if(Number.isFinite(sc)){
        map[id] = { score: sc, updated_at: String(row.updated_at || "").trim() };
      }
    });
    SCORES = map;
    applyScoresToUI();
    if(currentPersonId) setScoreInModal(currentPersonId);
    return true;
  }catch(e){
    alert("خطا در دریافت امتیازها: " + (e?.message || e));
    return false;
  }
}

/* ========= Team Duties ========= */
const TEAM = {
  top:{label:"Management", duties:[
    "طراحی و کنترل فرآیندهای Rate & Inventory / Capacity در کل شبکه",
    "تعیین SLA اقدام، استاندارد کیفیت دیتا و کنترل ریسک عملیاتی",
    "هدایت City Managers، تیم ظرفیت و تیم پنل/محتوا",
    "مدیریت backlog توسعه پنل و اتوماسیون‌ها",
    "Escalation و مدیریت بحران‌های نرخ/ظرفیت/Policy",
    "گزارش‌دهی و برنامه بهبود عملکرد"
  ]},
  dom:{label:"هتل‌های داخلی", duties:[
    "مدیریت ارتباط روزانه با هتل‌های داخلی برای نرخ/ظرفیت/پروموشن",
    "بروزرسانی دقیق نرخ‌ها و قوانین فروش + کنترل کیفیت قبل از انتشار",
    "کنترل Capacity و جلوگیری از Over/Under و Missed Sales",
    "رفع مغایرت‌های نرخ/اطلاعات/اتاق‌ها با مستندات هتل",
    "پایش KPIهای منطقه‌ای و Escalation به موقع"
  ]},
  for:{label:"هتل‌های خارجی", duties:[
    "مدیریت نرخ/ظرفیت با حساسیت روی Currency، Tax/Fee و Policy",
    "کنترل Policyها (Cancellation/No-show/Meal plan) و Mapping",
    "هماهنگی با Account Manager و تیم پنل"
  ]},
  pan:{label:"توسعه پنل و محتوا", duties:[
    "تحلیل نیازهای عملیاتی و تبدیل آن‌ها به فیچر/باگ قابل توسعه",
    "افزایش اتوماسیون و کاهش خطای انسانی (Validation / Bulk Update / Logs)",
    "بهبود UX پنل و مدیریت QA/Release",
    "مدیریت محتوا و استانداردسازی داده"
  ]},
  cap:{label:"تیم ظرفیت", duties:[
    "پایش روزانه Availability هتل‌های حساس و پرفروش",
    "کنترل Over/Under و اقدام اصلاحی سریع",
    "ساخت Watchlist ظرفیت و تعریف هشدارهای عملیاتی",
    "گزارش دوره‌ای ظرفیت و موارد بحرانی"
  ]}
};

/* ========= Chart Data (UPDATED) ========= */
const CHART = {
  top:{
    id:"top", team:"top", type:"Head",
    name:"محمد باقر ذوالفقاری",
    role:"Head of Supply Chain",
    chip:"Management",
    ext:"100",
    image:"./images/mbz.jpg"
  },
  departments:[
    {
      key:"dom",
      titleFA:"هتل‌های داخلی",
      titleEN:"Domestic Hotels",
      team:"dom",
      blocks:[
        { managerId:"cm1", specs:["sp2","sp6"] },      // Bagheri: Salari + Biabangard
        { managerId:"cm2", specs:["sp3","sp4"] },      // Ghodrati
        { managerId:"cm3", specs:["sp5","sp7"] }       // Davtalab
      ]
    },
    {
      key:"for",
      titleFA:"هتل‌های خارجی",
      titleEN:"Foreign Hotels (NEW)",
      team:"for",
      stack:["for1","for2","for3"]
    },
    {
      key:"pan",
      titleFA:"توسعه پنل و محتوا",
      titleEN:"Content & Panel Operations",
      team:"pan",
      stack:["pan1","pan2","pan3","pan4"]
    },
    {
      key:"cap",
      titleFA:"تیم ظرفیت",
      titleEN:"Capacity Team",
      team:"cap",
      stack:["cap1"]  // ✅ فقط مهلا — علیرضا حذف شد
    }
  ],
  people:{
    cm1:{id:"cm1",team:"dom",type:"City Manager",name:"محدثه باقری",role:"City Manager — Center",chip:"Manager",ext:"210",image:"./images/m_bagheri.jpg"},
    cm2:{id:"cm2",team:"dom",type:"City Manager",name:"نرگس قدرتی",role:"City Manager — East & South",chip:"Manager",ext:"220",image:"./images/n_ghodrati.jpg"},
    cm3:{id:"cm3",team:"dom",type:"City Manager",name:"سپیده داوطلب",role:"City Manager — North & West",chip:"Manager",ext:"230",image:"./images/s_davtalab.jpg"},

    // Domestic R&I (خسروی حذف شد)
    sp2:{id:"sp2",team:"dom",type:"R&I Specialist",name:"فائزه سالاری",role:"Rate & Inventory — Domestic",chip:"R&I",ext:"241",image:"./images/f_salari.jpg"},
    sp3:{id:"sp3",team:"dom",type:"R&I Specialist",name:"فاطمه رنجبر",role:"Rate & Inventory — Domestic",chip:"R&I",ext:"242",image:"./images/f_ranjbar.jpg"},
    sp4:{id:"sp4",team:"dom",type:"R&I Specialist",name:"افسانه مرادی",role:"Rate & Inventory — Domestic",chip:"R&I",ext:"243",image:"./images/a_moradi.jpg"},
    sp5:{id:"sp5",team:"dom",type:"R&I Specialist",name:"پگاه واعظین",role:"Rate & Inventory — Domestic",chip:"R&I",ext:"244",image:"./images/p_vaezin.jpg"},
    sp7:{id:"sp7",team:"dom",type:"R&I Specialist",name:"فاطمه رحیمی",role:"Rate & Inventory — Domestic",chip:"R&I",ext:"245",image:"./images/f_rahimi.jpg"},
    sp6:{id:"sp6",team:"dom",type:"R&I Specialist",name:"علیرضا بیابانگرد",role:"Rate & Inventory — Domestic",chip:"R&I",ext:"246",image:"./images/a_biabangard.jpg"},

    // Foreign (محمد شجاع اضافه شد)
    for1:{id:"for1",team:"for",type:"Account Manager",name:"Account Manager",role:"Foreign Hotels",chip:"Vacant",vacant:true,ext:"310",image:""},
    for2:{id:"for2",team:"for",type:"R&I Specialist",name:"محمد شجاع",role:"Rate & Inventory — Foreign Hotels",chip:"R&I",ext:"312",image:"./images/m_shoja.jpg"},
    for3:{id:"for3",team:"for",type:"R&I Specialist",name:"Rate & Inventory",role:"Foreign Hotels",chip:"Vacant",vacant:true,ext:"313",image:""},

    // Panel & Content
    pan1:{id:"pan1",team:"pan",type:"Lead",name:"منصوره یکتایی",role:"Lead — Panel Development",chip:"Lead",ext:"410",image:"./images/m_yektaei.jpg"},
    pan2:{id:"pan2",team:"pan",type:"Developer",name:"پریا گلی",role:"Panel Developer",chip:"Team",ext:"411",image:"./images/p_goli.jpg"},
    pan3:{id:"pan3",team:"pan",type:"Developer",name:"مهسا ناصری",role:"Panel Developer",chip:"Team",ext:"412",image:"./images/m_naseri.jpg"},
    pan4:{id:"pan4",team:"pan",type:"Content Admin",name:"Content Admin",role:"City Project",chip:"Vacant",vacant:true,ext:"413",image:""},

    // Capacity (فقط مهلا)
    cap1:{id:"cap1",team:"cap",type:"Capacity Specialist",name:"مهلا بهرامی‌زاده",role:"Capacity Specialist",chip:"Capacity",ext:"330",image:"./images/m_bahramizade.jpg"}
  }
};

/* ========= Job Descriptions ========= */
const JOBS = {
  top:{
    overview:"رهبری زنجیره تأمین هتل‌ها برای تضمین درستی و به‌روز بودن نرخ/ظرفیت/محتوا، افزایش فروش و کاهش خطا و ریسک عملیاتی.",
    responsibilities:[
      "طراحی و کنترل فرآیندهای Rate & Inventory و Capacity در کل شبکه",
      "هدایت City Managers، تیم ظرفیت و تیم پنل/محتوا",
      "سیاست‌گذاری SLA اقدام و استاندارد کیفیت دیتا",
      "مدیریت backlog توسعه پنل و اولویت‌بندی اتوماسیون‌ها",
      "Escalation و مدیریت بحران‌ها",
      "گزارش‌دهی و برنامه بهبود"
    ],
    kpis:["Freshness نرخ/ظرفیت","نرخ خطا","SLA اقدام","کاهش missed sales","اثرگذاری بر فروش/کانورژن"],
    tools:["Hotel Panel","CRM/Tickets","Dashboards","Ops Channels"]
  },
  cm1:{ overview:"مالک عملکرد تامین هتل‌های منطقه Center؛ تضمین کیفیت نرخ/ظرفیت، کاهش خطا و پیشبرد فروش منطقه.",
    responsibilities:["تقسیم کار و کنترل کیفیت","مدیریت مغایرت‌ها و Escalation","پایش KPI منطقه","هماهنگی با هتل‌ها","گزارش‌دهی منظم"],
    kpis:["Freshness","SLA","کاهش خطا","کاهش backlog","رشد فروش منطقه"],
    tools:["Hotel Panel","CRM/Tickets","Dashboards"]
  },
  cm2:{ overview:"مالک عملکرد تامین هتل‌های East & South؛ کنترل ریسک پیک‌ها و بهبود سرعت اقدام.",
    responsibilities:["هدایت تیم منطقه","کنترل ظرفیت در پیک‌ها","QA تغییرات حساس","رفع مغایرت‌ها","گزارش نیازهای سیستمی"],
    kpis:["Freshness","Lead time","Coverage ظرفیت","کاهش برگشت کار"],
    tools:["Hotel Panel","CRM/Tickets","Dashboards"]
  },
  cm3:{ overview:"مالک عملکرد تامین هتل‌های North & West؛ پایش نرخ رقابتی و حفظ کیفیت داده.",
    responsibilities:["کنترل کیفی نرخ/قوانین","پایش نرخ رقابتی","کنترل Stop-sell","رفع مغایرت‌ها","گزارش KPI"],
    kpis:["Freshness","TTR مغایرت","کاهش خطای تکراری","بهبود Conversion"],
    tools:["Hotel Panel","CRM/Tickets","Dashboards"]
  },

  sp2:{ overview:"اجرای Rate & Inventory داخلی با تمرکز بر سرعت اقدام و دقت داده.",
    responsibilities:["آپدیت نرخ/محدودیت‌ها","آپدیت ظرفیت/Stop-sell","اعمال پروموشن‌ها","رفع مغایرت‌ها","ثبت لاگ"],
    kpis:["Freshness","SLA","کاهش خطا","کیفیت نمایش"],
    tools:["Hotel Panel","CRM/Tickets","Checklists"]
  },
  sp3:{ overview:"اجرای دقیق تغییرات نرخ/ظرفیت داخلی و کمک به کاهش ریسک فروش.",
    responsibilities:["بروزرسانی نرخ/قوانین","آپدیت Availability","رفع مغایرت با هتل","کنترل مپینگ اتاق","ثبت لاگ"],
    kpis:["نرخ خطا","Freshness","SLA","TTR مغایرت"],
    tools:["Hotel Panel","CRM/Tickets","Dashboards"]
  },
  sp4:{ overview:"پایش کیفیت اطلاعات و اجرای عملیات Rate & Inventory داخلی.",
    responsibilities:["ثبت نرخ/ظرفیت","کنترل Policyها","رفع مغایرت اطلاعاتی","اعمال پروموشن‌ها","مستندسازی"],
    kpis:["کیفیت Policy","Freshness","کاهش خطای تکراری"],
    tools:["Hotel Panel","CRM/Tickets","Docs/Sheets"]
  },
  sp5:{ overview:"اجرای بروزرسانی‌های نرخ/ظرفیت و مدیریت استثناها برای کاهش missed sales.",
    responsibilities:["آپدیت نرخ","کنترل ظرفیت بحرانی","رفع مغایرت","QA نمونه‌ای","گزارش موارد مهم"],
    kpis:["Freshness","Coverage","SLA","کاهش missed sales"],
    tools:["Hotel Panel","Dashboards","Checklists"]
  },
  sp6:{ overview:"پشتیبانی Rate & Inventory داخلی با تمرکز بر دقت، سرعت و کاهش ریسک فروش.",
    responsibilities:["ثبت تغییرات","رفع مغایرت پرتکرار","کنترل قوانین/اطلاعات","گزارش موارد بحرانی","هماهنگی با CM"],
    kpis:["SLA","نرخ خطا","Freshness","TTR"],
    tools:["Hotel Panel","CRM/Tickets","Checklists"]
  },
  sp7:{ overview:"اجرای Rate & Inventory داخلی با تمرکز بر کیفیت دیتا و کاهش برگشت کار.",
    responsibilities:["آپدیت نرخ/ظرفیت","رفع خطای تکراری","کنترل نمایش","ثبت لاگ","همکاری با CM"],
    kpis:["Freshness","SLA","کیفیت نمایش","کاهش backlog"],
    tools:["Hotel Panel","CRM/Tickets","Dashboards"]
  },

  for1:{ overview:"(Vacant) مدیریت ارتباط با هتل‌های خارجی؛ دریافت نرخ/قرارداد/قوانین و تضمین فروش‌پذیری.",
    responsibilities:["مدیریت ارتباط با تامین‌کننده","دریافت و کنترل قوانین/Policy","حل اختلافات نرخ/Tax/Fee","هماهنگی با پنل"],
    kpis:["تعداد هتل فعال","Freshness خارجی","TTR مغایرت","رشد فروش خارجی"],
    tools:["Provider Panels","CRM/Tickets","Dashboards"]
  },
  for2:{ overview:"مدیریت و اجرای نرخ و ظرفیت هتل‌های خارجی با تمرکز بر صحت Policy، Currency و جلوگیری از مغایرت‌های فروش.",
    responsibilities:["آپدیت نرخ با ارز/Tax/Fee","مدیریت Availability/Stop-sell","کنترل Cancellation/No-show/Meal plan","رفع مغایرت با تامین‌کننده","گزارش نیازهای پنل"],
    kpis:["Freshness خارجی","کیفیت Policy","SLA اقدام","کاهش مغایرت"],
    tools:["Provider Panels","CRM/Tickets","Dashboards","Sheets"]
  },
  for3:{ overview:"(Vacant) اجرای Rate & Inventory خارجی (پوزیشن دوم) برای افزایش ظرفیت اجرایی تیم.",
    responsibilities:["آپدیت نرخ/ظرفیت","کنترل صحیح نمایش","رفع مغایرت پرتکرار","گزارش‌دهی"],
    kpis:["Freshness","SLA","TTR","نرخ خطا"],
    tools:["Provider Panels","CRM/Tickets"]
  },

  pan1:{ overview:"رهبری توسعه پنل/اتوماسیون عملیات تامین برای افزایش سرعت و کاهش خطا.",
    responsibilities:["مدیریت backlog","تحلیل نیاز عملیات","QA/Release discipline","طراحی Validation/Logs","UAT"],
    kpis:["زمان تحویل","Impact اتوماسیون","کیفیت Release","رضایت عملیات"],
    tools:["Issue Tracker","Repo/CI","Panel Admin"]
  },
  pan2:{ overview:"توسعه فیچرها و ابزارهای عملیاتی پنل با تمرکز بر سرعت اقدام تیم.",
    responsibilities:["توسعه فیچر","رفع باگ","Bulk Update/Validation","بهبود UX","مستندسازی"],
    kpis:["Velocity","Time-to-fix","Stability","Bug return rate"],
    tools:["Git","Issue Tracker","Monitoring"]
  },
  pan3:{ overview:"پشتیبانی توسعه پنل و اجرای بهبودهای سریع‌اثر.",
    responsibilities:["رفع باگ","بهبود لاگ/Audit","پشتیبانی UAT","مستندسازی"],
    kpis:["Time-to-fix","Regression","Stability"],
    tools:["Git","Issue Tracker","Panel"]
  },
  pan4:{ overview:"(Vacant) مدیریت محتوا: تکمیل داده‌ها و استانداردسازی برای افزایش conversion.",
    responsibilities:["تکمیل مشخصات/قوانین/تصاویر","استانداردسازی نام‌گذاری","QA صفحات","پایش کامل بودن محتوا"],
    kpis:["Content completeness","Quality errors","Conversion impact"],
    tools:["CMS/Panel","Checklists"]
  },

  cap1:{ overview:"کنترل و بهینه‌سازی ظرفیت/Availability برای کاهش missed sales و جلوگیری از overbooking.",
    responsibilities:["پایش Availability","کنترل Over/Under","هماهنگی با CMها","ساخت Watchlist","گزارش موارد بحرانی"],
    kpis:["Coverage","کاهش missed sales","کاهش over incidents","Speed of response"],
    tools:["Dashboards","Hotel Panel","CRM/Tickets"]
  }
};

/* ========= UI Builders ========= */
function displayName(p){
  const ext = p.ext ? ` <span style="color:#64748b;font-size:12px;font-weight:950">· ${esc(p.ext)}</span>` : "";
  return `${esc(p.name)}${ext}`;
}
function avatarHTML(p){
  const img = p.image ? String(p.image) : "";
  const ini = initials(p.name || p.id || "--");
  if(!img){
    return `<div class="avatar"><div class="initials">${esc(ini)}</div></div>`;
  }
  return `
    <div class="avatar">
      <img src="${esc(img)}" alt="${esc(p.name||"")}" crossorigin="anonymous"
           onerror="this.remove(); this.parentNode.innerHTML='<div class=&quot;initials&quot;>${esc(ini)}</div>';">
    </div>
  `;
}
function scoreHTML(id){
  const s = SCORES[id];
  if(!s || typeof s.score !== "number") return `<span class="scorePill" data-score-id="${esc(id)}"></span>`;
  const cls = scoreDotClass(s.score);
  return `<span class="scorePill show" data-score-id="${esc(id)}" title="${esc(s.updated_at||"")}"><span class="dot ${cls}"></span><span>${esc(String(s.score))}</span></span>`;
}
function personCard(p){
  const chipText = p.vacant ? "Vacant" : (p.chip || p.type || "");
  const pillCls = p.vacant ? "pill vacant" : "pill";
  return `
    <div class="card person" data-id="${esc(p.id)}"
         data-name="${esc(p.name)}" data-role="${esc(p.role)}" data-team="${esc(TEAM[p.team]?.label||p.team)}" tabindex="0">
      ${avatarHTML(p)}
      <div class="meta">
        <div class="name">${displayName(p)}</div>
        <div class="role">${esc(p.role)}</div>
      </div>
      ${scoreHTML(p.id)}
      <span class="${pillCls}">${esc(chipText)}</span>
    </div>
  `;
}
function topCard(){
  const p = CHART.top;
  return `
    <div class="card head">
      ${avatarHTML(p)}
      <div class="meta">
        <div class="name">${displayName(p)}</div>
        <div class="role">${esc(p.role)}</div>
      </div>
      ${scoreHTML("top")}
      <span class="pill">${esc(p.chip)}</span>
    </div>
  `;
}
function teamHeader(dept){
  return `
    <div class="teamHeader">
      <div class="t">
        <div class="a">${esc(dept.titleFA)}</div>
        <div class="b">${esc(dept.titleEN)}</div>
      </div>
      <button class="btnTiny" data-team="${esc(dept.team)}">وظایف تیم</button>
    </div>
  `;
}

/* ========= Render ========= */
function render(){
  document.getElementById("node-top").innerHTML = topCard();
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  for(const dept of CHART.departments){
    const col = document.createElement("div");
    col.className = "col";
    col.innerHTML = teamHeader(dept);

    const body = document.createElement("div");
    body.className = "sectionBody";

    if(dept.key === "dom"){
      for(const b of dept.blocks){
        const block = document.createElement("div");
        block.className = "managerBlock";
        block.innerHTML = personCard(CHART.people[b.managerId]);

        const sub = document.createElement("div");
        sub.className = "subList";
        for(const sid of b.specs){
          const sp = CHART.people[sid];
          if(!sp) continue;
          const w = document.createElement("div");
          w.className = "subItem";
          w.innerHTML = personCard(sp);
          sub.appendChild(w);
        }
        block.appendChild(sub);
        body.appendChild(block);
      }
    } else {
      for(const id of (dept.stack||[])){
        const p = CHART.people[id];
        if(!p) continue;
        body.innerHTML += personCard(p);
      }
    }

    col.appendChild(body);
    grid.appendChild(col);
  }

  wire();
  applyScoresToUI();
  applySearch();
  requestAnimationFrame(redrawLines);
}

/* ========= Nicer curved lines ========= */
function rect(el, stage){
  const r = el.getBoundingClientRect();
  const s = stage.getBoundingClientRect();
  return { left:r.left-s.left, right:r.right-s.left, top:r.top-s.top, bottom:r.bottom-s.top, cx:(r.left+r.right)/2 - s.left };
}
function svgPath(d){
  const p = document.createElementNS("http://www.w3.org/2000/svg","path");
  p.setAttribute("d", d);
  p.setAttribute("fill","none");
  p.setAttribute("stroke","url(#lg)");
  p.setAttribute("stroke-width","2.2");
  p.setAttribute("stroke-linecap","round");
  p.setAttribute("stroke-linejoin","round");
  p.setAttribute("opacity","0.95");
  return p;
}
function svgDot(x,y){
  const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
  c.setAttribute("cx", x);
  c.setAttribute("cy", y);
  c.setAttribute("r", 3.4);
  c.setAttribute("fill", "#94a3b8");
  c.setAttribute("opacity","0.9");
  return c;
}
function redrawLines(){
  const stage = document.getElementById("stage");
  const svg = document.getElementById("lines");
  svg.innerHTML = "";

  const sr = stage.getBoundingClientRect();
  svg.setAttribute("viewBox", `0 0 ${sr.width} ${sr.height}`);

  // defs gradient
  const defs = document.createElementNS("http://www.w3.org/2000/svg","defs");
  const lg = document.createElementNS("http://www.w3.org/2000/svg","linearGradient");
  lg.setAttribute("id","lg");
  lg.setAttribute("x1","0"); lg.setAttribute("y1","0");
  lg.setAttribute("x2","0"); lg.setAttribute("y2","1");
  const s1 = document.createElementNS("http://www.w3.org/2000/svg","stop");
  s1.setAttribute("offset","0%");
  s1.setAttribute("stop-color","#cbd5e1");
  const s2 = document.createElementNS("http://www.w3.org/2000/svg","stop");
  s2.setAttribute("offset","100%");
  s2.setAttribute("stop-color","#94a3b8");
  lg.appendChild(s1); lg.appendChild(s2);
  defs.appendChild(lg);
  svg.appendChild(defs);

  const top = stage.querySelector("#node-top .card");
  const teamCards = [...stage.querySelectorAll(".teamHeader")];
  if(!top || teamCards.length === 0) return;

  const topR = rect(top, stage);
  const tRects = teamCards.map(c => rect(c, stage));

  const yMid = Math.min(...tRects.map(t => t.top)) - 18;
  const xMin = Math.min(...tRects.map(t => t.cx));
  const xMax = Math.max(...tRects.map(t => t.cx));

  // vertical from top to mid with smooth curve
  const x0 = topR.cx, y0 = topR.bottom;
  const y1 = yMid;

  // main trunk
  svg.appendChild(svgPath(`M ${x0} ${y0} C ${x0} ${y0+24}, ${x0} ${y1-24}, ${x0} ${y1}`));
  svg.appendChild(svgDot(x0, y0));
  svg.appendChild(svgDot(x0, y1));

  // horizontal bus (as a smooth curve)
  const bus = svgPath(`M ${xMin} ${y1} C ${xMin+40} ${y1}, ${xMax-40} ${y1}, ${xMax} ${y1}`);
  svg.appendChild(bus);

  // branches down to each team header
  tRects.forEach(t=>{
    const xb = t.cx;
    const yb = t.top;
    const d = `M ${xb} ${y1} C ${xb} ${y1+22}, ${xb} ${yb-22}, ${xb} ${yb}`;
    svg.appendChild(svgPath(d));
    svg.appendChild(svgDot(xb, yb));
  });
}

/* ========= Modal ========= */
const modalBack = document.getElementById("modalBack");
const btnClose = document.getElementById("btnClose");
const btnRefreshScores = document.getElementById("btnRefreshScores");
const mAvatar = document.getElementById("mAvatar");
const mName = document.getElementById("mName");
const mRole = document.getElementById("mRole");
const mTeamPill = document.getElementById("mTeamPill");
const mTypePill = document.getElementById("mTypePill");
const mScorePill = document.getElementById("mScorePill");
const mScoreDot = document.getElementById("mScoreDot");
const mScoreText = document.getElementById("mScoreText");

let currentPersonId = null;
let currentPerson = null;

function setScoreInModal(id){
  const s = SCORES[id];
  if(!s || typeof s.score !== "number"){
    mScorePill.classList.remove("show");
    return;
  }
  mScorePill.classList.add("show");
  mScoreText.textContent = String(s.score);
  mScoreDot.className = "dot " + scoreDotClass(s.score);
  mScorePill.title = s.updated_at || "";
}
function openModal(id){
  const person = (id === "top") ? CHART.top : CHART.people[id];
  if(!person) return;

  currentPersonId = id;
  currentPerson = person;

  // avatar
  mAvatar.innerHTML = "";
  const ini = initials(person.name);
  if(person.image){
    const img = document.createElement("img");
    img.src = person.image;
    img.alt = person.name || "";
    img.crossOrigin = "anonymous";
    img.style.width="100%"; img.style.height="100%"; img.style.objectFit="cover"; img.style.display="block";
    img.onerror = () => { mAvatar.innerHTML = `<div class="initials">${esc(ini)}</div>`; };
    mAvatar.appendChild(img);
  } else {
    mAvatar.innerHTML = `<div class="initials">${esc(ini)}</div>`;
  }

  const extText = person.ext ? ` <span style="font-size:13px;color:#64748b">· ${esc(person.ext)}</span>` : "";
  mName.innerHTML = `${esc(person.name)}${extText}`;
  mRole.textContent = person.role || "—";

  mTeamPill.className = "pill";
  mTeamPill.textContent = TEAM[person.team]?.label || "—";
  mTypePill.className = "pill";
  mTypePill.textContent = person.type || (person.vacant ? "Vacant" : "—");

  setScoreInModal(id);

  const jd = JOBS[id] || {overview:"شرح شغلی ثبت نشده است.", responsibilities:[], kpis:[], tools:[]};

  document.getElementById("tab-overview").innerHTML = `
    <div style="font-weight:950;color:rgba(15,23,42,.78);margin:0 0 8px;">Mission / Overview</div>
    <div style="line-height:2;color:rgba(15,23,42,.88);font-weight:850;background:rgba(15,23,42,.03);border:1px solid rgba(15,23,42,.07);border-radius:16px;padding:12px;">
      ${esc(jd.overview)}
    </div>
  `;
  document.getElementById("tab-resp").innerHTML = `
    <div style="font-weight:950;color:rgba(15,23,42,.78);margin:0 0 8px;">Responsibilities</div>
    <ul style="margin:0;padding-right:18px;line-height:2;color:rgba(15,23,42,.88);font-weight:850;">
      ${(jd.responsibilities||[]).map(x=>`<li>${esc(x)}</li>`).join("") || "<li>—</li>"}
    </ul>
  `;
  document.getElementById("tab-kpi").innerHTML = `
    <div style="font-weight:950;color:rgba(15,23,42,.78);margin:0 0 8px;">KPIs</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
      ${(jd.kpis||[]).map(k=>`
        <div style="border:1px solid rgba(15,23,42,.08);border-radius:18px;padding:12px;background:rgba(248,250,252,.9);">
          <div style="font-weight:950;margin-bottom:6px;">KPI</div>
          <div style="color:rgba(15,23,42,.80);font-weight:850;line-height:1.9;">${esc(k)}</div>
        </div>
      `).join("") || `<div style="border:1px solid rgba(15,23,42,.08);border-radius:18px;padding:12px;background:rgba(248,250,252,.9);">—</div>`}
    </div>
  `;
  document.getElementById("tab-tools").innerHTML = `
    <div style="font-weight:950;color:rgba(15,23,42,.78);margin:0 0 8px;">Tools</div>
    <ul style="margin:0;padding-right:18px;line-height:2;color:rgba(15,23,42,.88);font-weight:850;">
      ${(jd.tools||[]).map(x=>`<li>${esc(x)}</li>`).join("") || "<li>—</li>"}
    </ul>
  `;
  const td = TEAM[person.team]?.duties || [];
  document.getElementById("tab-team").innerHTML = `
    <div style="font-weight:950;color:rgba(15,23,42,.78);margin:0 0 8px;">Team Duties — ${esc(TEAM[person.team]?.label||"")}</div>
    <div style="background:rgba(248,250,252,.9);border:1px solid rgba(15,23,42,.08);border-radius:18px;padding:12px;">
      <ul style="margin:0;padding-right:18px;line-height:2;color:rgba(15,23,42,.88);font-weight:850;">
        ${td.map(x=>`<li>${esc(x)}</li>`).join("") || "<li>—</li>"}
      </ul>
    </div>
  `;

  // show modal
  modalBack.style.display = "flex";

  // set tab active
  setActiveTab("tab-overview");
}
function closeModal(){
  modalBack.style.display = "none";
  currentPersonId = null;
  currentPerson = null;
}
btnClose.addEventListener("click", closeModal);
modalBack.addEventListener("click",(e)=>{ if(e.target===modalBack) closeModal(); });
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") { closeModal(); closeLightbox(); } });

function setActiveTab(id){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.remove("active");
    t.style.background="#fff"; t.style.color="#0f172a";
  });
  document.querySelectorAll(".tabContent").forEach(c=>{ c.style.display="none"; c.classList.remove("active"); });
  const t = document.querySelector(`.tab[data-tab="${id}"]`);
  if(t){
    t.classList.add("active");
    t.style.background="#0f172a"; t.style.color="#fff";
  }
  const c = document.getElementById(id);
  if(c){ c.style.display="block"; c.classList.add("active"); }
}
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=> setActiveTab(t.dataset.tab));
});

btnRefreshScores.addEventListener("click", async ()=>{
  const ok = await fetchScores();
  if(ok && currentPersonId) setScoreInModal(currentPersonId);
});

/* ========= Lightbox ========= */
const lbBack = document.getElementById("lbBack");
const lbImg = document.getElementById("lbImg");
const lbTitle = document.getElementById("lbTitle");
const lbZoomIn = document.getElementById("lbZoomIn");
const lbZoomOut = document.getElementById("lbZoomOut");
const lbReset = document.getElementById("lbReset");
const lbClose = document.getElementById("lbClose");

let lbScale = 1;

function openLightbox(){
  if(!currentPerson || !currentPerson.image) return;
  lbScale = 1;
  lbImg.style.transform = "scale(1)";
  lbImg.src = currentPerson.image;
  lbTitle.textContent = currentPerson.name || "Photo";
  lbBack.style.display = "flex";
}
function closeLightbox(){ lbBack.style.display = "none"; }
function applyLBScale(){
  lbScale = clamp(lbScale, 1, 4);
  lbImg.style.transform = `scale(${lbScale})`;
}
document.getElementById("mAvatar").addEventListener("click", openLightbox);
lbClose.addEventListener("click", closeLightbox);
lbBack.addEventListener("click",(e)=>{ if(e.target===lbBack) closeLightbox(); });
lbZoomIn.addEventListener("click",()=>{ lbScale += 0.25; applyLBScale(); });
lbZoomOut.addEventListener("click",()=>{ lbScale -= 0.25; applyLBScale(); });
lbReset.addEventListener("click",()=>{ lbScale = 1; applyLBScale(); });
lbImg.addEventListener("click",()=>{ lbScale = (lbScale>=2.5)?1:(lbScale+0.75); applyLBScale(); });

/* ========= Wire interactions ========= */
function wire(){
  document.querySelectorAll(".card.person").forEach(card=>{
    card.addEventListener("click", ()=> openModal(card.dataset.id));
    card.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" || e.key===" "){ e.preventDefault(); openModal(card.dataset.id); }
    });
  });

  document.querySelectorAll(".btnTiny").forEach(btn=>{
    btn.addEventListener("click",(e)=>{
      e.stopPropagation();
      const teamKey = btn.dataset.team;
      // open modal with any person from that team (or top)
      let id = "top";
      if(teamKey !== "top"){
        const found = Object.values(CHART.people).find(p=>p.team===teamKey);
        id = found?.id || "top";
      }
      openModal(id);
      setActiveTab("tab-team");
    });
  });
}

/* ========= Scores UI ========= */
function applyScoresToUI(){
  document.querySelectorAll(".scorePill").forEach(el=>{
    const id = el.getAttribute("data-score-id");
    const s = SCORES[id];
    if(!s || typeof s.score !== "number"){
      el.classList.remove("show");
      el.innerHTML = "";
      return;
    }
    el.classList.add("show");
    const cls = scoreDotClass(s.score);
    el.innerHTML = `<span class="dot ${cls}"></span><span>${esc(String(s.score))}</span>`;
    el.title = s.updated_at || "";
  });
}

/* ========= Search ========= */
let searchTerm = "";
function applySearch(){
  const q = norm(searchTerm);
  const cards = [...document.querySelectorAll(".card.person")];
  if(!q){
    cards.forEach(c=>{ c.classList.remove("hidden","hit"); });
    return;
  }
  cards.forEach(c=>{
    const hay = norm((c.dataset.name||"") + " " + (c.dataset.role||"") + " " + (c.dataset.team||""));
    const ok = hay.includes(q);
    c.classList.toggle("hidden", !ok);
    c.classList.toggle("hit", ok);
  });
}

/* Search icon toggle */
const searchWrap = document.getElementById("searchWrap");
const searchBtn = document.getElementById("searchBtn");
const searchInput = document.getElementById("searchInput");

searchBtn.addEventListener("click", ()=>{
  searchWrap.classList.toggle("open");
  if(searchWrap.classList.contains("open")){
    setTimeout(()=> searchInput.focus(), 50);
  }else{
    searchInput.value = "";
    searchTerm = "";
    applySearch();
  }
});
searchInput.addEventListener("input", ()=>{
  searchTerm = searchInput.value;
  applySearch();
});
document.addEventListener("keydown",(e)=>{
  if(e.key === "/" && !modalBack.style.display){
    e.preventDefault();
    searchWrap.classList.add("open");
    setTimeout(()=> searchInput.focus(), 50);
  }
});

/* ========= Buttons ========= */
document.getElementById("btnScores").addEventListener("click", fetchScores);

document.getElementById("btnExportPng").addEventListener("click", async ()=>{
  const stage = document.getElementById("stage");
  try{
    // wait all images in stage
    const imgs = Array.from(stage.querySelectorAll("img"));
    await Promise.all(imgs.map(img=>{
      if(img.complete && img.naturalWidth>0) return Promise.resolve();
      return new Promise(res=>{ img.onload = img.onerror = ()=>res(); });
    }));

    const canvas = await html2canvas(stage, {
      backgroundColor: "#ffffff",
      scale: 2,
      useCORS: true,
      allowTaint: false,
      imageTimeout: 15000
    });

    const url = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = url;
    a.download = "supply_org_chart.png";
    document.body.appendChild(a);
    a.click();
    a.remove();
  }catch(e){
    alert("خروجی تصویر ناموفق بود. اگر عکسی از دامنه بیرونی داری، باید روی همان دامنه CORS داشته باشد.\nخطا: " + (e?.message || e));
  }
});

/* ========= Init ========= */
render();
window.addEventListener("load", redrawLines);
window.addEventListener("resize", ()=> requestAnimationFrame(redrawLines));

// redraw lines after any img loads
document.addEventListener("load",(e)=>{
  if(e.target?.tagName === "IMG") requestAnimationFrame(redrawLines);
}, true);
</script>

</body>
</html>
